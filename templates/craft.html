{% extends "base.html" %}

{% block content %}
<div class="craft-container">
    <h1 class="text-center mb-4">üî® –ö—Ä–∞—Ñ—Ç —Å–∫–∏–Ω–æ–≤</h1>
    
    <div class="row">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –≤—ã–±–æ—Ä —Å–∫–∏–Ω–æ–≤ –∏ –∫—Ä–∞—Ñ—Ç -->
        <div class="col-md-6">
            <div class="craft-controls">
                <div class="craft-slot-section mb-4">
                    <h4>üéí –í—ã–±–µ—Ä–∏—Ç–µ 2 —Å–∫–∏–Ω–∞ –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞</h4>
                    <div class="craft-slots">
                        <div class="craft-slot" id="slot1" onclick="openSkinSelector(1)">
                            <div class="slot-placeholder">
                                <span class="slot-icon">‚ûï</span>
                                <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω 1</span>
                            </div>
                        </div>
                        <div class="craft-plus">+</div>
                        <div class="craft-slot" id="slot2" onclick="openSkinSelector(2)">
                            <div class="slot-placeholder">
                                <span class="slot-icon">‚ûï</span>
                                <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω 2</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="selected-skins mb-4" id="selectedSkins">
                    <!-- –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
                
                <div class="craft-info mb-4">
                    <h5>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—Ä–∞—Ñ—Ç–µ</h5>
                    <div class="craft-stats">
                        <div class="stat-item">
                            <span>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span id="totalValue">0 UC</span>
                        </div>
                        <div class="stat-item">
                            <span>–°—Ä–µ–¥–Ω—è—è —Ä–µ–¥–∫–æ—Å—Ç—å:</span>
                            <span id="averageRarity">-</span>
                        </div>
                        <div class="stat-item">
                            <span>–®–∞–Ω—Å —É–ª—É—á—à–µ–Ω–∏—è:</span>
                            <span id="upgradeChance">0%</span>
                        </div>
                        <div class="stat-item">
                            <span>–®–∞–Ω—Å —É—Ö—É–¥—à–µ–Ω–∏—è:</span>
                            <span id="downgradeChance">0%</span>
                        </div>
                        <div class="stat-item">
                            <span>–û–∂–∏–¥–∞–µ–º–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                            <span id="expectedValue">0 UC</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-craft" id="craftBtn" onclick="startCraft()" disabled>
                    üî® –°–∫—Ä–∞—Ñ—Ç–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="col-md-6">
            <div class="craft-info-sidebar">
                <div class="rules-section mb-4">
                    <h4>üìã –ü—Ä–∞–≤–∏–ª–∞ –∫—Ä–∞—Ñ—Ç–∞</h4>
                    <div class="rules-list">
                        <div class="rule-item">
                            <span class="rule-icon">üî®</span>
                            <span>–û–±—ä–µ–¥–∏–Ω–∏—Ç–µ 2 —Å–∫–∏–Ω–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–∫–∏–Ω–∞</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">‚ö°</span>
                            <span>–†–µ–¥–∫–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–∫–∏–Ω–æ–≤</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üìà</span>
                            <span>30% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–Ω –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üìâ</span>
                            <span>20% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–Ω –Ω–∞ 1 —É—Ä–æ–≤–µ–Ω—å –Ω–∏–∂–µ</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üéØ</span>
                            <span>50% —à–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–Ω —Ç–æ–π –∂–µ —Ä–µ–¥–∫–æ—Å—Ç–∏</span>
                        </div>
                        <div class="rule-item">
                            <span class="rule-icon">üí•</span>
                            <span>–ü—Ä–∏ –∫—Ä–∞—Ñ—Ç–µ –æ–±–∞ —Å–∫–∏–Ω–∞ —Ç–µ—Ä—è—é—Ç—Å—è</span>
                        </div>
                    </div>
                </div>
                
                <div class="chances-section mb-4">
                    <h4>üé∞ –®–∞–Ω—Å—ã –∫—Ä–∞—Ñ—Ç–∞</h4>
                    <div class="chances-list">
                        <div class="chance-item chance-upgrade">
                            <span class="chance-icon">üìà</span>
                            <span class="chance-text">–£–ª—É—á—à–µ–Ω–∏–µ (+1 —É—Ä–æ–≤–µ–Ω—å)</span>
                            <span class="chance-percent">30%</span>
                        </div>
                        <div class="chance-item chance-same">
                            <span class="chance-icon">üéØ</span>
                            <span class="chance-text">–¢–∞–∫–∞—è –∂–µ —Ä–µ–¥–∫–æ—Å—Ç—å</span>
                            <span class="chance-percent">50%</span>
                        </div>
                        <div class="chance-item chance-downgrade">
                            <span class="chance-icon">üìâ</span>
                            <span class="chance-text">–£—Ö—É–¥—à–µ–Ω–∏–µ (-1 —É—Ä–æ–≤–µ–Ω—å)</span>
                            <span class="chance-percent">20%</span>
                        </div>
                    </div>
                </div>
                
                <div class="craft-result" id="craftResult">
                    <h4>üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—Ä–∞—Ñ—Ç–∞</h4>
                    <div class="result-placeholder">
                        <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—Ä–∞—Ñ—Ç–∞</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–∫–∏–Ω–∞ -->
<div id="skinSelectorModal" class="modal-custom-hidden">
    <div class="modal-custom-content">
        <div class="modal-custom-header">
            <h4>üéí –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω</h4>
        </div>
        <div class="modal-custom-body">
            <div class="inventory-selector" id="inventorySelector">
                <!-- –°–∫–∏–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        <div class="modal-custom-footer">
            <button class="btn btn-cancel" onclick="closeSkinSelector()">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫—Ä–∞—Ñ—Ç–∞
let selectedSkins = {1: null, 2: null};
let currentSlot = null;
let userInventory = [];

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getSkinRarity(skinPrice) {
    if (skinPrice <= 50) return 'common';
    if (skinPrice <= 300) return 'rare';
    if (skinPrice <= 1500) return 'epic';
    if (skinPrice <= 5000) return 'legendary';
    if (skinPrice <= 50000) return 'mythical';
    return 'ancient';
}

function getRarityName(rarity) {
    const names = {
        'common': '–û–±—ã—á–Ω—ã–π', 'rare': '–†–µ–¥–∫–∏–π', 'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', 'mythical': '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π', 'ancient': '–î—Ä–µ–≤–Ω–∏–π'
    };
    return names[rarity] || '–û–±—ã—á–Ω—ã–π';
}

function getRarityColor(rarity) {
    const colors = {
        'common': '#6c757d', 'rare': '#007bff', 'epic': '#8a2be2',
        'legendary': '#ff6b6b', 'mythical': '#ff00ff', 'ancient': '#00ffff'
    };
    return colors[rarity] || '#6c757d';
}

function getRarityOrder(rarity) {
    const order = ['common', 'rare', 'epic', 'legendary', 'mythical', 'ancient'];
    return order.indexOf(rarity);
}

function getRarityByOrder(order) {
    const rarities = ['common', 'rare', 'epic', 'legendary', 'mythical', 'ancient'];
    return rarities[Math.max(0, Math.min(order, rarities.length - 1))];
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
});

function loadInventory() {
    fetch('/api/get_inventory')
        .then(response => response.json())
        .then(data => {
            userInventory = data.skins;
        });
}

// –§—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ —Å–∫–∏–Ω–æ–≤
function openSkinSelector(slotNumber) {
    currentSlot = slotNumber;
    const modal = document.getElementById('skinSelectorModal');
    const selector = document.getElementById('inventorySelector');
    
    selector.innerHTML = '';
    
    if (userInventory.length === 0) {
        selector.innerHTML = '<p class="text-center">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
    } else {
        userInventory.forEach(skin => {
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã –≤ –¥—Ä—É–≥–æ–º —Å–ª–æ—Ç–µ
            if (Object.values(selectedSkins).some(s => s && s.id === skin.id)) {
                return;
            }
            
            const skinElement = document.createElement('div');
            const rarity = getSkinRarity(skin.price);
            skinElement.className = 'inventory-selector-item';
            skinElement.onclick = () => selectSkinForCraft(skin);
            skinElement.innerHTML = `
                <img src="${skin.image}" alt="${skin.name}">
                <div class="skin-details">
                    <h6>${skin.name}</h6>
                    <span class="skin-price">${skin.price.toLocaleString()} UC</span>
                    <span class="skin-rarity ${rarity}">${getRarityName(rarity)}</span>
                </div>
            `;
            selector.appendChild(skinElement);
        });
    }
    
    modal.classList.add('modal-show');
}

function closeSkinSelector() {
    const modal = document.getElementById('skinSelectorModal');
    modal.classList.remove('modal-show');
    currentSlot = null;
}

function selectSkinForCraft(skin) {
    if (!currentSlot) return;
    
    selectedSkins[currentSlot] = skin;
    updateSelectedSkinsDisplay();
    updateCraftInfo();
    closeSkinSelector();
}

function removeSkinFromSlot(slotNumber) {
    selectedSkins[slotNumber] = null;
    updateSelectedSkinsDisplay();
    updateCraftInfo();
}

function updateSelectedSkinsDisplay() {
    const selectedSkinsDiv = document.getElementById('selectedSkins');
    const slot1 = document.getElementById('slot1');
    const slot2 = document.getElementById('slot2');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ—Ç—ã
    [1, 2].forEach(slot => {
        const slotElement = document.getElementById(`slot${slot}`);
        const skin = selectedSkins[slot];
        
        if (skin) {
            const rarity = getSkinRarity(skin.price);
            slotElement.innerHTML = `
                <div class="selected-skin">
                    <img src="${skin.image}" alt="${skin.name}">
                    <div class="skin-info">
                        <h6>${skin.name}</h6>
                        <span class="skin-rarity ${rarity}">${getRarityName(rarity)}</span>
                        <span class="skin-price">${skin.price.toLocaleString()} UC</span>
                    </div>
                    <button class="btn-remove" onclick="removeSkinFromSlot(${slot})">‚ùå</button>
                </div>
            `;
        } else {
            slotElement.innerHTML = `
                <div class="slot-placeholder" onclick="openSkinSelector(${slot})">
                    <span class="slot-icon">‚ûï</span>
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω ${slot}</span>
                </div>
            `;
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤
    selectedSkinsDiv.innerHTML = '';
    Object.entries(selectedSkins).forEach(([slot, skin]) => {
        if (skin) {
            const rarity = getSkinRarity(skin.price);
            const skinElement = document.createElement('div');
            skinElement.className = 'selected-skin-item';
            skinElement.innerHTML = `
                <span class="slot-number">${slot}</span>
                <img src="${skin.image}" alt="${skin.name}">
                <div class="skin-details">
                    <h6>${skin.name}</h6>
                    <span class="skin-rarity ${rarity}">${getRarityName(rarity)}</span>
                </div>
                <span class="skin-value">${skin.price.toLocaleString()} UC</span>
            `;
            selectedSkinsDiv.appendChild(skinElement);
        }
    });
}

function updateCraftInfo() {
    const totalValue = document.getElementById('totalValue');
    const averageRarity = document.getElementById('averageRarity');
    const upgradeChance = document.getElementById('upgradeChance');
    const downgradeChance = document.getElementById('downgradeChance');
    const expectedValue = document.getElementById('expectedValue');
    const craftBtn = document.getElementById('craftBtn');
    
    const skins = Object.values(selectedSkins).filter(skin => skin !== null);
    
    if (skins.length !== 2) {
        totalValue.textContent = '0 UC';
        averageRarity.textContent = '-';
        upgradeChance.textContent = '0%';
        downgradeChance.textContent = '0%';
        expectedValue.textContent = '0 UC';
        craftBtn.disabled = true;
        return;
    }
    
    // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    const totalPrice = skins.reduce((sum, skin) => sum + skin.price, 0);
    totalValue.textContent = totalPrice.toLocaleString() + ' UC';
    
    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
    const avgPrice = totalPrice / 2;
    const avgRarity = getSkinRarity(avgPrice);
    averageRarity.textContent = getRarityName(avgRarity);
    
    // –®–∞–Ω—Å—ã (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
    upgradeChance.textContent = '30%';
    downgradeChance.textContent = '20%';
    
    // –†–∞—Å—á–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    const avgRarityOrder = getRarityOrder(avgRarity);
    const possibleRarities = [
        getRarityByOrder(avgRarityOrder - 1), // –£—Ö—É–¥—à–µ–Ω–∏–µ
        avgRarity,                            // –¢–∞–∫–∞—è –∂–µ
        getRarityByOrder(avgRarityOrder + 1)  // –£–ª—É—á—à–µ–Ω–∏–µ
    ];
    
    // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–µ–¥–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
    const rarityPrices = {
        'common': 25, 'rare': 200, 'epic': 1000,
        'legendary': 3500, 'mythical': 27500, 'ancient': 200000
    };
    
    let expectedPrice = 0;
    possibleRarities.forEach((rarity, index) => {
        const chance = index === 0 ? 0.2 : index === 1 ? 0.5 : 0.3;
        expectedPrice += rarityPrices[rarity] * chance;
    });
    
    expectedValue.textContent = Math.round(expectedPrice).toLocaleString() + ' UC';
    expectedValue.className = expectedPrice >= totalPrice ? 'text-success' : 'text-danger';
    
    craftBtn.disabled = false;
}

function startCraft() {
    if (Object.values(selectedSkins).filter(s => s !== null).length !== 2) return;
    
    const craftBtn = document.getElementById('craftBtn');
    craftBtn.disabled = true;
    craftBtn.textContent = '–ö—Ä–∞—Ñ—Ç–∏—Ç—Å—è...';
    
    const skin1 = selectedSkins[1];
    const skin2 = selectedSkins[2];
    const avgPrice = (skin1.price + skin2.price) / 2;
    const avgRarity = getSkinRarity(avgPrice);
    const avgRarityOrder = getRarityOrder(avgRarity);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫—Ä–∞—Ñ—Ç–∞
    const random = Math.random();
    let resultRarityOrder;
    
    if (random < 0.3) {
        // –£–ª—É—á—à–µ–Ω–∏–µ (30%)
        resultRarityOrder = Math.min(avgRarityOrder + 1, 5);
    } else if (random < 0.8) {
        // –¢–∞–∫–∞—è –∂–µ —Ä–µ–¥–∫–æ—Å—Ç—å (50%)
        resultRarityOrder = avgRarityOrder;
    } else {
        // –£—Ö—É–¥—à–µ–Ω–∏–µ (20%)
        resultRarityOrder = Math.max(avgRarityOrder - 1, 0);
    }
    
    const resultRarity = getRarityByOrder(resultRarityOrder);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–∫–∏–Ω –≤—ã–ø–∞–≤—à–µ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
    const resultSkin = generateRandomSkin(resultRarity);
    
    // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        showCraftResult(resultSkin, skin1, skin2, resultRarityOrder - avgRarityOrder);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫—Ä–∞—Ñ—Ç
        fetch('/api/craft_skins', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                skin1_id: skin1.id,
                skin2_id: skin2.id,
                result_skin: resultSkin
            })
        }).then(() => {
            updateHeaderBalance();
            loadInventory();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã
            selectedSkins = {1: null, 2: null};
            updateSelectedSkinsDisplay();
            updateCraftInfo();
        });
        
        craftBtn.disabled = false;
        craftBtn.textContent = 'üî® –°–∫—Ä–∞—Ñ—Ç–∏—Ç—å';
        
    }, 2000);
}

function generateRandomSkin(rarity) {
    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
    const skinTemplates = {
        'common': [
            {name: '–°–∫—Ä–∞—Ñ—á–µ–Ω–Ω—ã–π M416', price: 20},
            {name: '–°–∫—Ä–∞—Ñ—á–µ–Ω–Ω—ã–π AKM', price: 25},
            {name: '–°–∫—Ä–∞—Ñ—á–µ–Ω–Ω—ã–π UMP9', price: 15}
        ],
        'rare': [
            {name: '–£–ª—É—á—à–µ–Ω–Ω—ã–π M416', price: 150},
            {name: '–£–ª—É—á—à–µ–Ω–Ω—ã–π AKM', price: 180},
            {name: '–£–ª—É—á—à–µ–Ω–Ω—ã–π AWM', price: 300}
        ],
        'epic': [
            {name: '–≠–ø–∏—á–µ—Å–∫–∏–π M416', price: 800},
            {name: '–≠–ø–∏—á–µ—Å–∫–∏–π AKM', price: 900},
            {name: '–≠–ø–∏—á–µ—Å–∫–∏–π AWM', price: 1500}
        ],
        'legendary': [
            {name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π M416', price: 2500},
            {name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π AKM', price: 2800},
            {name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π AWM', price: 5000}
        ],
        'mythical': [
            {name: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π M416', price: 15000},
            {name: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π AKM', price: 20000},
            {name: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π AWM', price: 30000}
        ],
        'ancient': [
            {name: '–î—Ä–µ–≤–Ω–∏–π M416', price: 150000},
            {name: '–î—Ä–µ–≤–Ω–∏–π AKM', price: 200000},
            {name: '–î—Ä–µ–≤–Ω–∏–π AWM', price: 300000}
        ]
    };
    
    const templates = skinTemplates[rarity] || skinTemplates.common;
    const template = templates[Math.floor(Math.random() * templates.length)];
    
    return {
        id: Date.now(), // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
        name: template.name,
        image: `https://via.placeholder.com/100/${getRarityColor(rarity).substring(1)}/ffffff?text=CRAFT`,
        price: template.price,
        rarity: rarity
    };
}

function showCraftResult(resultSkin, skin1, skin2, rarityChange) {
    const resultDiv = document.getElementById('craftResult');
    const resultRarity = getSkinRarity(resultSkin.price);
    
    let resultText = '';
    let resultClass = '';
    
    if (rarityChange > 0) {
        playSound('craftSuccessSound');
        resultText = 'üìà –£–ª—É—á—à–µ–Ω–∏–µ!';
        resultClass = 'result-success';
    } else if (rarityChange < 0) {
        playSound('craftFailSound');
        resultText = 'üìâ –£—Ö—É–¥—à–µ–Ω–∏–µ';
        resultClass = 'result-fail';
    } else {
        playSound('craftSuccessSound');
        resultText = 'üéØ –¢–∞–∫–∞—è –∂–µ —Ä–µ–¥–∫–æ—Å—Ç—å';
        resultClass = 'result-same';
    }
    
    const profit = resultSkin.price - skin1.price - skin2.price;
    
    resultDiv.innerHTML = `
        <div class="${resultClass}">
            <h4>${resultText}</h4>
            <div class="craft-animation">
                <div class="input-skins">
                    <div class="input-skin">
                        <img src="${skin1.image}" alt="${skin1.name}">
                        <span>${skin1.price.toLocaleString()} UC</span>
                    </div>
                    <div class="craft-symbol">+</div>
                    <div class="input-skin">
                        <img src="${skin2.image}" alt="${skin2.name}">
                        <span>${skin2.price.toLocaleString()} UC</span>
                    </div>
                    <div class="craft-arrow">üî®‚û°Ô∏è</div>
                </div>
                <div class="result-skin">
                    <img src="${resultSkin.image}" alt="${resultSkin.name}">
                    <div class="skin-rarity ${resultRarity}">${getRarityName(resultRarity)}</div>
                    <h5>${resultSkin.name}</h5>
                    <p class="skin-value">${resultSkin.price.toLocaleString()} UC</p>
                </div>
            </div>
            <div class="profit-info">
                <p class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                    ${profit >= 0 ? '‚úÖ' : '‚ùå'} ${profit >= 0 ? '+' : ''}${profit.toLocaleString()} UC
                </p>
            </div>
        </div>
    `;
    
    if (profit >= 0) {
        showNotification(`üéâ –ö—Ä–∞—Ñ—Ç —É—Å–ø–µ—à–µ–Ω! –ü—Ä–∏–±—ã–ª—å: +${profit} UC`);
    } else {
        showNotification(`üí• –ö—Ä–∞—Ñ—Ç –Ω–µ –≤—ã–≥–æ–¥–µ–Ω. –£–±—ã—Ç–æ–∫: ${profit} UC`, 'error');
    }
}
</script>

<style>
.craft-container {
    padding: 20px;
}

.craft-controls {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    height: 100%;
}

.craft-info-sidebar {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    height: 100%;
}

/* –°–ª–æ—Ç—ã –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞ */
.craft-slots {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
}

.craft-slot {
    width: 150px;
    height: 180px;
    border: 3px dashed #8a2be2;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
}

.craft-slot:hover {
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.1);
}

.craft-plus {
    font-size: 24px;
    color: #ffd700;
    font-weight: bold;
}

.slot-placeholder {
    text-align: center;
    color: #b19cd9;
}

.slot-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 8px;
}

.selected-skin {
    position: relative;
    padding: 10px;
    text-align: center;
    height: 100%;
}

.selected-skin img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 8px;
    border: 2px solid #8a2be2;
}

.skin-info h6 {
    margin: 8px 0 4px 0;
    color: white;
    font-size: 12px;
}

.btn-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(220, 53, 69, 0.8);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    color: white;
    font-size: 10px;
    cursor: pointer;
}

/* –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–∫–∏–Ω—ã */
.selected-skins {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #8a2be2;
}

.selected-skin-item {
    display: flex;
    align-items: center;
    padding: 8px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
}

.slot-number {
    background: #8a2be2;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    margin-right: 10px;
}

.selected-skin-item img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-right: 10px;
    border-radius: 5px;
}

.selected-skin-item .skin-details {
    flex: 1;
}

.selected-skin-item .skin-details h6 {
    margin: 0;
    font-size: 12px;
    color: white;
}

.skin-value {
    color: #ffd700;
    font-weight: bold;
    font-size: 12px;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—Ä–∞—Ñ—Ç–µ */
.craft-stats {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #8a2be2;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    color: white;
    font-size: 14px;
}

.stat-item span:last-child {
    color: #ffd700;
    font-weight: bold;
}

.btn-craft {
    background: linear-gradient(45deg, #8a2be2, #4b0082);
    border: none;
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 16px;
    width: 100%;
    transition: all 0.3s ease;
    margin-top: 10px;
}

.btn-craft:hover:not(:disabled) {
    background: linear-gradient(45deg, #9b4dff, #5a00a8);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(138, 43, 226, 0.4);
}

.btn-craft:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* –ü—Ä–∞–≤–∏–ª–∞ –∏ —à–∞–Ω—Å—ã */
.rules-list {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #8a2be2;
}

.rule-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    color: #b19cd9;
    font-size: 14px;
}

.rule-icon {
    font-size: 18px;
    margin-right: 10px;
    min-width: 20px;
}

.chances-list {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #8a2be2;
}

.chance-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    font-weight: bold;
}

.chance-upgrade {
    background: rgba(40, 167, 69, 0.2);
    border-left: 4px solid #28a745;
}

.chance-same {
    background: rgba(255, 193, 7, 0.2);
    border-left: 4px solid #ffc107;
}

.chance-downgrade {
    background: rgba(220, 53, 69, 0.2);
    border-left: 4px solid #dc3545;
}

.chance-icon {
    font-size: 20px;
    margin-right: 10px;
}

.chance-text {
    flex: 1;
    color: white;
}

.chance-percent {
    color: #ffd700;
    font-size: 16px;
}

/* –†–µ–∑—É–ª—å—Ç–∞—Ç –∫—Ä–∞—Ñ—Ç–∞ */
.craft-result {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border-radius: 8px;
    min-height: 300px;
    border: 1px solid #8a2be2;
}

.placeholder-text {
    text-align: center;
    color: #b19cd9;
    padding: 60px 0;
    font-style: italic;
}

.craft-animation {
    text-align: center;
}

.input-skins {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.input-skin {
    text-align: center;
}

.input-skin img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 6px;
    border: 2px solid #8a2be2;
}

.craft-symbol {
    font-size: 20px;
    color: #ffd700;
    font-weight: bold;
}

.craft-arrow {
    font-size: 20px;
    color: #ffd700;
}

.result-skin {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    border: 2px solid #8a2be2;
}

.result-skin img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    border-radius: 8px;
    margin-bottom: 8px;
}

.skin-value {
    color: #ffd700;
    font-weight: bold;
    font-size: 16px;
}

.profit-info {
    text-align: center;
    margin-top: 15px;
}

.profit-positive {
    color: #28a745;
    font-weight: bold;
    font-size: 16px;
}

.profit-negative {
    color: #dc3545;
    font-weight: bold;
    font-size: 16px;
}

.result-success {
    border-left: 4px solid #28a745;
    padding-left: 15px;
}

.result-same {
    border-left: 4px solid #ffc107;
    padding-left: 15px;
}

.result-fail {
    border-left: 4px solid #dc3545;
    padding-left: 15px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–∫–∏–Ω–∞ */
.inventory-selector {
    max-height: 400px;
    overflow-y: auto;
}

.inventory-selector-item {
    display: flex;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #8a2be2;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.inventory-selector-item:hover {
    background: rgba(138, 43, 226, 0.2);
    border-color: #ffd700;
}

.inventory-selector-item img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-right: 10px;
    border-radius: 5px;
}

.inventory-selector-item .skin-details h6 {
    margin: 0;
    color: white;
    font-size: 14px;
}

.text-success { color: #28a745 !important; }
.text-danger { color: #dc3545 !important; }

/* –†–µ–¥–∫–æ—Å—Ç–∏ */
.skin-rarity {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
    display: inline-block;
}

.skin-rarity.common { background: #6c757d; color: white; }
.skin-rarity.rare { background: #007bff; color: white; }
.skin-rarity.epic { background: #8a2be2; color: white; }
.skin-rarity.legendary { background: #ff6b6b; color: white; }
.skin-rarity.mythical { background: #ff00ff; color: white; }
.skin-rarity.ancient { background: #00ffff; color: black; }
</style>
{% endblock %}