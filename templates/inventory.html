{% extends "base.html" %}

{% block content %}
<div class="inventory-container">
    <h1 class="text-center mb-4">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h1>

    <div class="inventory-stats mb-4">
        <div class="stat-card">
            <h5>–í—Å–µ–≥–æ —Å–∫–∏–Ω–æ–≤</h5>
            <span class="skin-count" id="skinCount">0</span>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div class="sorting-panel mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</h5>
            </div>
            <div class="col-md-6">
                <div class="sort-controls">
                    <select class="form-select" id="sortField">
                        <option value="price">–ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</option>
                        <option value="rarity">–ü–æ —Ä–µ–¥–∫–æ—Å—Ç–∏</option>
                        <option value="date">–ü–æ –Ω–æ–≤–∏–∑–Ω–µ</option>
                        <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    </select>
                    <select class="form-select" id="sortOrder">
                        <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é ‚ñº</option>
                        <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é ‚ñ≤</option>
                    </select>
                    <button class="btn btn-sort" onclick="applySorting()">
                        üîÑ –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="inventory-skins">
        <h3 class="mb-3">–í–∞—à–∏ —Å–∫–∏–Ω—ã</h3>
        <div class="row" id="inventorySkins">
            <!-- –°–∫–∏–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
let currentSortField = 'price';
let currentSortOrder = 'desc';
let allSkins = [];

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∫–æ—Å—Ç–µ–π
function getSkinRarity(skinPrice) {
    if (skinPrice <= 50) return 'common';
    if (skinPrice <= 300) return 'rare';
    if (skinPrice <= 1500) return 'epic';
    if (skinPrice <= 5000) return 'legendary';
    if (skinPrice <= 50000) return 'mythical';
    return 'ancient';
}

function getRarityName(rarity) {
    const names = {
        'common': '–û–±—ã—á–Ω—ã–π',
        'rare': '–†–µ–¥–∫–∏–π',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π',
        'mythical': '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π',
        'ancient': '–î—Ä–µ–≤–Ω–∏–π'
    };
    return names[rarity] || '–û–±—ã—á–Ω—ã–π';
}

function getRarityOrder(rarity) {
    const order = {
        'common': 1,
        'rare': 2,
        'epic': 3,
        'legendary': 4,
        'mythical': 5,
        'ancient': 6
    };
    return order[rarity] || 0;
}

// –§—É–Ω–∫—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function sortSkins(skins, field, order) {
    return skins.sort((a, b) => {
        let valueA, valueB;

        switch (field) {
            case 'price':
                valueA = a.price;
                valueB = b.price;
                break;
            case 'rarity':
                valueA = getRarityOrder(getSkinRarity(a.price));
                valueB = getRarityOrder(getSkinRarity(b.price));
                break;
            case 'date':
                valueA = new Date(a.acquired_at);
                valueB = new Date(b.acquired_at);
                break;
            case 'name':
                valueA = a.name.toLowerCase();
                valueB = b.name.toLowerCase();
                break;
            default:
                valueA = a.price;
                valueB = b.price;
        }

        // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        if (typeof valueA === 'number') {
            return order === 'desc' ? valueB - valueA : valueA - valueB;
        }

        // –î–ª—è –¥–∞—Ç
        if (valueA instanceof Date) {
            return order === 'desc' ? valueB - valueA : valueA - valueB;
        }

        // –î–ª—è —Å—Ç—Ä–æ–∫
        if (order === 'desc') {
            return valueB.localeCompare(valueA);
        } else {
            return valueA.localeCompare(valueB);
        }
    });
}

function applySorting() {
    playSound('clickSound');
    currentSortField = document.getElementById('sortField').value;
    currentSortOrder = document.getElementById('sortOrder').value;
    displayInventory();
}

function loadInventory() {
    fetch('/api/get_inventory')
        .then(response => response.json())
        .then(data => {
            document.getElementById('skinCount').textContent = data.skins.length;
            allSkins = data.skins;

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            allSkins.forEach(skin => {
                skin.rarity = getSkinRarity(skin.price);
                skin.rarity_order = getRarityOrder(skin.rarity);
            });

            displayInventory();
        });
}

function displayInventory() {
    const inventoryContainer = document.getElementById('inventorySkins');
    inventoryContainer.innerHTML = '';

    if (allSkins.length === 0) {
        inventoryContainer.innerHTML = `
            <div class="col-12">
                <div class="empty-inventory text-center">
                    <div class="empty-icon">üéí</div>
                    <h4>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</h4>
                    <p>–û—Ç–∫—Ä–æ–π—Ç–µ –∫–µ–π—Å—ã —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–Ω—ã!</p>
                    <a href="/cases" class="btn btn-primary">üéÅ –û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å—ã</a>
                </div>
            </div>
        `;
        return;
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∫–∏–Ω—ã
    const sortedSkins = sortSkins([...allSkins], currentSortField, currentSortOrder);

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
    updateSortInfo();

    sortedSkins.forEach(skin => {
        const skinElement = document.createElement('div');
        skinElement.className = 'col-md-3 mb-4';
        const rarity = getSkinRarity(skin.price);

        skinElement.innerHTML = `
            <div class="inventory-skin-card">
                <div class="skin-header">
                    <span class="skin-rarity ${rarity}">${getRarityName(rarity)}</span>
                    <span class="skin-date">${formatDate(skin.acquired_at)}</span>
                </div>
                <img src="${skin.image}" alt="${skin.name}">
                <div class="skin-info">
                    <h6>${skin.name}</h6>
                    <p class="skin-price">${skin.price.toLocaleString()} UC</p>
                    <button class="btn btn-sell-inventory"
                            onclick="showSellConfirm(${skin.id}, '${skin.name.replace(/'/g, "\\'")}', '${skin.image}', ${skin.price})">
                        üí∞ –ü—Ä–æ–¥–∞—Ç—å
                    </button>
                </div>
            </div>
        `;
        inventoryContainer.appendChild(skinElement);
    });
}

function formatDate(dateString) {
    if (!dateString) return '';

    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 1) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 2) return '–í—á–µ—Ä–∞';
    if (diffDays <= 7) return `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;

    return date.toLocaleDateString('ru-RU');
}

function updateSortInfo() {
    const sortFieldSelect = document.getElementById('sortField');
    const sortOrderSelect = document.getElementById('sortOrder');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    sortFieldSelect.value = currentSortField;
    sortOrderSelect.value = currentSortOrder;
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select
    document.getElementById('sortField').addEventListener('change', applySorting);
    document.getElementById('sortOrder').addEventListener('change', applySorting);
});

// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
window.addEventListener('focus', function() {
    loadInventory();
});
</script>

<style>
.inventory-container {
    padding: 20px;
}

.inventory-stats {
    display: flex;
    justify-content: center;
}

.stat-card {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    min-width: 200px;
}

.stat-card h5 {
    color: #b19cd9;
    margin-bottom: 10px;
    font-size: 16px;
}

.skin-count {
    color: #ffd700;
    font-size: 24px;
    font-weight: bold;
}

/* –ü–∞–Ω–µ–ª—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
.sorting-panel {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 15px;
}

.sort-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.form-select {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #8a2be2;
    color: white;
    border-radius: 5px;
    padding: 8px 12px;
}

.form-select:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #b19cd9;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(138, 43, 226, 0.25);
}

.btn-sort {
    background: linear-gradient(45deg, #8a2be2, #4b0082);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn-sort:hover {
    background: linear-gradient(45deg, #9b4dff, #5a00a8);
    transform: translateY(-2px);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–∏–Ω–æ–≤ */
.inventory-skin-card {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
}

.inventory-skin-card:hover {
    transform: translateY(-5px);
    border-color: #b19cd9;
    box-shadow: 0 10px 20px rgba(138, 43, 226, 0.3);
}

.skin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.skin-rarity {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: bold;
}

.skin-rarity.common { background: #6c757d; color: white; }
.skin-rarity.rare { background: #007bff; color: white; }
.skin-rarity.epic { background: #8a2be2; color: white; }
.skin-rarity.legendary { background: #ff6b6b; color: white; }
.skin-rarity.mythical { background: #ff00ff; color: white; }
.skin-rarity.ancient { background: #00ffff; color: black; }

.skin-date {
    font-size: 10px;
    color: #b19cd9;
}

.inventory-skin-card img {
    width: 100px;
    height: 100px;
    object-fit: contain;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 2px solid #8a2be2;
    background: rgba(255, 255, 255, 0.1);
}

.skin-info h6 {
    color: white;
    margin-bottom: 8px;
    font-size: 14px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.skin-price {
    color: #ffd700;
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 10px;
}

.btn-sell-inventory {
    background: linear-gradient(45deg, #ffc107, #fd7e14);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 12px;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-sell-inventory:hover {
    background: linear-gradient(45deg, #ffca2c, #fd9843);
    transform: translateY(-2px);
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
.empty-inventory {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 40px;
    margin: 20px 0;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.empty-inventory h4 {
    color: white;
    margin-bottom: 10px;
}

.empty-inventory p {
    color: #b19cd9;
    margin-bottom: 20px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .sort-controls {
        flex-direction: column;
    }

    .form-select {
        width: 100%;
    }

    .btn-sort {
        width: 100%;
    }

    .inventory-skin-card {
        margin-bottom: 15px;
    }
}
</style>
{% endblock %}