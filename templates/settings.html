{% extends "base.html" %}

{% block content %}
<div class="settings-container">
    <h1 class="text-center mb-4">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h1>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="settings-card">
                <!-- –°–º–µ–Ω–∞ –Ω–∏–∫–∞ -->
                <div class="setting-section mb-4">
                    <h4>üë§ –°–º–µ–Ω–∞ –Ω–∏–∫–Ω–µ–π–º–∞</h4>
                    <div class="setting-content">
                        <p class="text-muted">–¢–µ–∫—É—â–∏–π –Ω–∏–∫: <strong>{{ session.get('username', 'User') }}</strong></p>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="newUsername" 
                                       placeholder="–ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º" maxlength="20">
                                <div class="form-text">–ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤</div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="changeUsername()">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
                <div class="setting-section mb-4">
                    <h4>üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h4>
                    <div class="setting-content">
                        <div class="row mb-3">
                            <div class="col-12">
                                <input type="password" class="form-control" id="currentPassword" 
                                       placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="password" class="form-control" id="newPassword" 
                                       placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
                            </div>
                            <div class="col-md-6">
                                <input type="password" class="form-control" id="confirmPassword" 
                                       placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-warning w-100" onclick="changePassword()">
                                    üîê –°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
                <div class="setting-section mb-4">
                    <h4>üñºÔ∏è –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏</h4>
                    <div class="setting-content">
                        <div class="current-avatar mb-3">
                            <img src="{{ url_for('static', filename='images/avatars/' + current_avatar) }}"
                                 alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-preview" id="avatarPreview">
                            <span class="avatar-text">–¢–µ–∫—É—â–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞</span>
                        </div>
                        
                        <div class="avatar-selection">
                            <h6>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—É—é –∞–≤–∞—Ç–∞—Ä–∫—É:</h6>
                            <div class="avatar-grid">
                                {% for i in range(1, 9) %}
                                <div class="avatar-option {% if current_avatar == 'avatar' ~ i ~ '.png' %}selected{% endif %}" 
                                     onclick="selectAvatar('avatar{{ i }}.png')">
                                    <img src="{{ url_for('static', filename='images/avatars/avatar' ~ i ~ '.png') }}" 
                                         alt="–ê–≤–∞—Ç–∞—Ä {{ i }}">
                                </div>
                                {% endfor %}
                            </div>
                            <button class="btn btn-success mt-3" onclick="saveAvatar()" id="saveAvatarBtn" disabled>
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞ -->
                <div class="setting-section mb-4">
                    <h4>üîä –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞</h4>
                    <div class="setting-content">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="soundToggle" checked>
                            <label class="form-check-label" for="soundToggle">
                                –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫–∏ –≤ –∏–≥—Ä–∞—Ö
                            </label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="musicToggle">
                            <label class="form-check-label" for="musicToggle">
                                –§–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞
                            </label>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="setting-section">
                    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h4>
                    <div class="setting-content">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                                <span>{{ registration_date }}</span>
                            </div>
                            <div class="stat-item">
                                <span>–í—Å–µ–≥–æ —Å—ã–≥—Ä–∞–Ω–æ –∏–≥—Ä:</span>
                                <span>{{ total_games }}</span>
                            </div>
                            <div class="stat-item">
                                <span>–û—Ç–∫—Ä—ã—Ç–æ –∫–µ–π—Å–æ–≤:</span>
                                <span>{{ cases_opened }}</span>
                            </div>
                            <div class="stat-item">
                                <span>–í—Å–µ–≥–æ —Å–∫–∏–Ω–æ–≤:</span>
                                <span>{{ total_skins }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedAvatar = null;

function changeUsername() {
    const newUsername = document.getElementById('newUsername').value.trim();
    
    if (!newUsername) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º!', 'error');
        return;
    }
    
    if (newUsername.length < 3 || newUsername.length > 20) {
        showNotification('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
        return;
    }

    fetch('/api/change_username', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({new_username: newUsername})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ù–∏–∫–Ω–µ–π–º —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
            document.getElementById('newUsername').value = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ —Å–µ—Å—Å–∏–∏
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∏–∫–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –Ω–∏–∫–∞', 'error');
    });
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
        return;
    }

    if (newPassword.length < 4) {
        showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
        return;
    }

    if (newPassword !== confirmPassword) {
        showNotification('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
        return;
    }

    fetch('/api/change_password', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è', 'error');
    });
}

function selectAvatar(avatarName) {
    selectedAvatar = avatarName;
    document.getElementById('avatarPreview').src = `/static/images/avatars/${avatarName}`;
    document.getElementById('saveAvatarBtn').disabled = false;
    
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
    document.querySelectorAll('.avatar-option').forEach(option => {
        option.classList.remove('selected');
    });
    event.target.closest('.avatar-option').classList.add('selected');
}

function saveAvatar() {
    if (!selectedAvatar) return;

    fetch('/api/change_avatar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({avatar: selectedAvatar})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –ê–≤–∞—Ç–∞—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞!');
            document.getElementById('saveAvatarBtn').disabled = true;
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–≤–∞—Ç–∞—Ä–∫–∏', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–≤–∞—Ç–∞—Ä–∫–∏', 'error');
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–≤—É–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
    document.getElementById('soundToggle').checked = soundEnabled;
    
    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–≤—É–∫–∞
    document.getElementById('soundToggle').addEventListener('change', function() {
        localStorage.setItem('soundEnabled', this.checked);
        showNotification(this.checked ? 'üîä –ó–≤—É–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã' : 'üîá –ó–≤—É–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã');
    });
    
    document.getElementById('musicToggle').addEventListener('change', function() {
        showNotification(this.checked ? 'üéµ –ú—É–∑—ã–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞' : 'üéµ –ú—É–∑—ã–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
    });
});
</script>

<style>
.settings-container {
    padding: 20px;
}

.settings-card {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 30px;
}

.setting-section {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #8a2be2;
    border-radius: 8px;
    padding: 20px;
}

.setting-section h4 {
    color: #ffd700;
    margin-bottom: 15px;
    font-size: 18px;
}

.setting-content {
    color: #b19cd9;
}

/* –ê–≤–∞—Ç–∞—Ä–∫–∏ */
.current-avatar {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.avatar-preview {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid #8a2be2;
    object-fit: cover;
}

.avatar-text {
    color: white;
    font-weight: 500;
}

.avatar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.avatar-option {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 5px;
    transition: all 0.3s ease;
}

.avatar-option:hover {
    border-color: #8a2be2;
    transform: scale(1.05);
}

.avatar-option.selected {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.avatar-option img {
    width: 100%;
    border-radius: 6px;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
}

.stat-item span:first-child {
    color: #b19cd9;
}

.stat-item span:last-child {
    color: #ffd700;
    font-weight: bold;
}

/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ */
.form-check-input:checked {
    background-color: #8a2be2;
    border-color: #8a2be2;
}

.form-check-label {
    color: white;
    cursor: pointer;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .avatar-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}