<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Casino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notification-show {
            opacity: 1;
            visibility: visible;
            top: 30px;
        }

        .notification-content {
            background: linear-gradient(45deg, #8a2be2, #4b0082);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            text-align: center;
            min-width: 300px;
        }

        .notification-success .notification-content {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .notification-error .notification-content {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ - –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø */
        #sellConfirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        #sellConfirmModal.modal-show {
            display: flex;
        }

        .modal-custom-content {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
            border: 3px solid #8a2be2;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-custom-header {
            background: linear-gradient(90deg, #8a2be2, #4b0082);
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .modal-custom-header h4 {
            color: white;
            margin: 0;
            font-weight: bold;
        }

        .modal-custom-body {
            padding: 25px;
            text-align: center;
            color: white;
        }

        #sellSkinInfo {
            margin-bottom: 20px;
        }

        #sellSkinInfo img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            border: 2px solid #8a2be2;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        #sellSkinInfo h5 {
            margin: 10px 0;
            color: #ffd700;
        }

        .modal-custom-footer {
            padding: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid #8a2be2;
        }

        .btn-cancel, .btn-confirm {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-cancel {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .btn-cancel:hover {
            background: linear-gradient(45deg, #5a6268, #3d4348);
            transform: translateY(-2px);
        }

        .btn-confirm {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-confirm:hover {
            background: linear-gradient(45deg, #218838, #1e9c7a);
            transform: translateY(-2px);
        }

        /* –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(138, 43, 226, 0.8);
            border: 2px solid #ffd700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .sound-toggle:hover {
            background: rgba(138, 43, 226, 1);
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            background: rgba(108, 117, 125, 0.8);
            border-color: #6c757d;
        }

        /* –ê–≤–∞—Ç–∞—Ä–∫–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .avatar-small {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #ffd700;
            margin-right: 8px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark navbar-expand-lg main-nav">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Example</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('cases') }}">–ö–µ–π—Å—ã</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('inventory') }}">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('plane') }}">–°–∞–º–æ–ª–µ—Ç</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upgrade') }}">–£–ª—É—á—à–µ–Ω–∏–µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('craft') }}">–ö—Ä–∞—Ñ—Ç</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('mines') }}">–°–∞–ø–µ—Ä</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('withdraw') }}">–í—ã–≤–æ–¥</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('calendar') }}">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('quests') }}">üéØ –ö–≤–µ—Å—Ç—ã</a>
                    </li>
                    {% if session.get('username') == 'Developer' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_panel') }}">üëë Admin Panel</a>
                    </li>
                    {% endif %}
                </ul>
                <div class="navbar-nav ms-auto">
                    {% if session.get('user_id') %}
                    <div class="nav-item balance-container">
                        <span class="nav-link balance-text" id="userBalance">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <img src="{{ url_for('static', filename='images/avatars/' + (session.get('avatar', 'avatar1.png'))) }}"
                                 alt="Avatar" class="avatar-small">
                            {{ session.get('username', 'User') }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('settings') }}">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth_logout') }}">üö™ –í—ã–π—Ç–∏</a></li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% block content %}{% endblock %}
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notification" class="notification-hidden">
        <div class="notification-content">
            <span id="notificationText"></span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏ -->
    <div id="sellConfirmModal">
        <div class="modal-custom-content">
            <div class="modal-custom-header">
                <h4>üí∞ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h4>
            </div>
            <div class="modal-custom-body">
                <div id="sellSkinInfo">
                    <img id="sellSkinImage" src="" alt="–°–∫–∏–Ω">
                    <h5 id="sellSkinName"></h5>
                    <p>–¶–µ–Ω–∞: <span id="sellSkinPrice" class="uc-price"></span> UC</p>
                </div>
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å —ç—Ç–æ—Ç —Å–∫–∏–Ω?</p>
            </div>
            <div class="modal-custom-footer">
                <button class="btn btn-cancel" onclick="hideSellConfirm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-confirm" onclick="confirmSell()">‚úÖ –ü—Ä–æ–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º -->
    <div class="sound-toggle" id="soundToggle" onclick="toggleSound()">
        <span id="soundIcon">üîä</span>
    </div>

    <!-- –ó–≤—É–∫–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <audio id="clickSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/click.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="caseOpenSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/case_open.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="caseRollSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/case_roll.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="caseWinSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/case_win.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="caseLoseSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/case_lose.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="planeStartSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/plane_start.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="planeCrashSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/plane_crash.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="planeCashoutSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/plane_cashout.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="mineOpenSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/mine_open.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="mineExplodeSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/mine_explode.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="mineCashoutSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/mine_cashout.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="craftSuccessSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/craft_success.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="craftFailSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/craft_fail.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="upgradeSuccessSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/upgrade_success.mp3') }}" type="audio/mpeg">
    </audio>
    <audio id="upgradeFailSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/upgrade_fail.mp3') }}" type="audio/mpeg">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–≤—É–∫–æ–≤
        let soundEnabled = true;

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞
        function playSound(soundId) {
            if (!soundEnabled) return;

            const sound = document.getElementById(soundId);
            if (sound) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggle = document.getElementById('soundToggle');
            const icon = document.getElementById('soundIcon');

            if (soundEnabled) {
                toggle.classList.remove('muted');
                icon.textContent = 'üîä';
                // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤—É–∫
                playSound('clickSound');
            } else {
                toggle.classList.add('muted');
                icon.textContent = 'üîá';
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤ localStorage
            localStorage.setItem('soundEnabled', soundEnabled);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∑–≤—É–∫–∞
        document.addEventListener('DOMContentLoaded', function() {
            const savedSound = localStorage.getItem('soundEnabled');
            if (savedSound !== null) {
                soundEnabled = savedSound === 'true';
                if (!soundEnabled) {
                    document.getElementById('soundToggle').classList.add('muted');
                    document.getElementById('soundIcon').textContent = 'üîá';
                }
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫ –∫–ª–∏–∫–∞ –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    playSound('clickSound');
                }
            });

            // –ó–≤—É–∫ –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', () => playSound('clickSound'));
            });
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–≤—É–∫–æ–≤
        window.playSound = playSound;
        window.soundEnabled = soundEnabled;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentSellSkinId = null;
        let isModalOpen = false;

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤ —à–∞–ø–∫–µ
        function updateHeaderBalance() {
            fetch('/api/get_user_info')
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (data.balance !== undefined) {
                        document.getElementById('userBalance').textContent = data.balance + ' UC';
                    }
                })
                .catch(error => {
                    console.error('Error updating balance:', error);
                    document.getElementById('userBalance').textContent = '–û—à–∏–±–∫–∞';
                });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateHeaderBalance();

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
            setInterval(updateHeaderBalance, 10000);
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');

            notificationText.textContent = message;
            notification.className = 'notification-show ' + (type === 'success' ? 'notification-success' : 'notification-error');

            setTimeout(() => {
                notification.className = 'notification-hidden';
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showSellConfirm(skinId, skinName, skinImage, skinPrice) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
            if (isModalOpen) return;

            currentSellSkinId = skinId;
            isModalOpen = true;

            document.getElementById('sellSkinImage').src = skinImage;
            document.getElementById('sellSkinName').textContent = skinName;
            document.getElementById('sellSkinPrice').textContent = skinPrice;

            const modal = document.getElementById('sellConfirmModal');
            modal.classList.add('modal-show');

            // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
            document.body.style.overflow = 'hidden';
        }

        function hideSellConfirm() {
            const modal = document.getElementById('sellConfirmModal');
            modal.classList.remove('modal-show');

            currentSellSkinId = null;
            isModalOpen = false;

            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
            document.body.style.overflow = '';
        }

        function confirmSell() {
            if (!currentSellSkinId) return;

            const skinId = currentSellSkinId;
            hideSellConfirm();

            fetch('/api/sell_skin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({skin_id: skinId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`üí∞ –°–∫–∏–Ω –ø—Ä–æ–¥–∞–Ω –∑–∞ ${data.price} UC!`);
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ —à–∞–ø–∫–µ
                    updateHeaderBalance();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è loadInventory
                    if (typeof loadInventory === 'function') {
                        loadInventory();
                    }
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Å–∫–∏–Ω–∞', 'error');
                }
            })
            .catch(error => {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Å–∫–∏–Ω–∞', 'error');
            });
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
        document.getElementById('sellConfirmModal').addEventListener('click', function(event) {
            if (event.target === this) {
                hideSellConfirm();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && isModalOpen) {
                hideSellConfirm();
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)
        window.updateHeaderBalance = updateHeaderBalance;
        window.showNotification = showNotification;
        window.showSellConfirm = showSellConfirm;
        window.hideSellConfirm = hideSellConfirm;
        window.confirmSell = confirmSell;
    </script>
</body>
</html>