{% extends "base.html" %}

{% block content %}
<div class="plane-game-container">
    <h1 class="text-center mb-4">‚úàÔ∏è –ò–≥—Ä–∞ "–°–∞–º–æ–ª–µ—Ç"</h1>
    
    <div class="row">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="col-md-4">
            <div class="game-info-sidebar">
                <div class="game-rules mb-4">
                    <h4>üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</h4>
                    <p>–°–∞–º–æ–ª–µ—Ç –≤–∑–ª–µ—Ç–∞–µ—Ç –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤—ã–∏–≥—Ä—ã—à–∞.</p>
                    <p>–ó–∞–¥–∞—á–∞ - —É—Å–ø–µ—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ —Å–∞–º–æ–ª–µ—Ç –≤–∑–æ—Ä–≤–µ—Ç—Å—è!</p>
                    <p>–ß–µ–º –¥–æ–ª—å—à–µ –∂–¥–µ—à—å - —Ç–µ–º –±–æ–ª—å—à–µ –≤—ã–∏–≥—Ä—ã—à, –Ω–æ –≤—ã—à–µ —Ä–∏—Å–∫ –ø—Ä–æ–∏–≥—Ä–∞—Ç—å.</p>
                    <p class="text-warning">‚ö†Ô∏è –í–∑—Ä—ã–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª—É—á–∞–π–Ω–æ - –Ω–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç –∫–æ–≥–¥–∞!</p>
                </div>

                <div class="bet-controls mb-4">
                    <h5>üíµ –°—Ç–∞–≤–∫–∞ UC</h5>
                    <div class="bet-amount-control">
                        <button class="btn btn-bet-control" onclick="changeBet(-100)">-100</button>
                        <input type="number" id="betAmount" class="bet-input" value="100" min="10" max="10000000">
                        <button class="btn btn-bet-control" onclick="changeBet(100)">+100</button>
                    </div>
                    <div class="bet-presets">
                        <button class="btn btn-bet-preset" onclick="setBet(100)">100 UC</button>
                        <button class="btn btn-bet-preset" onclick="setBet(1000)">1,000 UC</button>
                        <button class="btn btn-bet-preset" onclick="setBet(10000)">10,000 UC</button>
                        <button class="btn btn-bet-preset" onclick="setBet(100000)">100,000 UC</button>
                        <button class="btn btn-bet-preset" onclick="setBet(1000000)">1,000,000 UC</button>
                        <button class="btn btn-bet-preset" onclick="setBet(10000000)">10,000,000 UC</button>
                    </div>
                </div>

                <div class="game-controls">
                    <button class="btn btn-start-game" id="startGameBtn" onclick="startGame()">üõ´ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–º–æ–ª–µ—Ç</button>
                    <button class="btn btn-cashout" id="cashoutBtn" onclick="cashout()" disabled>üí∞ –í—ã–≤–µ—Å—Ç–∏</button>
                </div>

                <div class="game-stats mt-4">
                    <div class="stat-item">
                        <span>–¢–µ–∫—É—â–∏–π –º–Ω–æ–∂–∏—Ç–µ–ª—å:</span>
                        <span id="currentMultiplier">1.00x</span>
                    </div>
                    <div class="stat-item">
                        <span>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:</span>
                        <span id="potentialWin">0 UC</span>
                    </div>
                    <div class="stat-item">
                        <span>–ë–∞–ª–∞–Ω—Å:</span>
                        <span id="gameBalance">0 UC</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
        <div class="col-md-8">
            <div class="game-field">
                <div class="plane-track">
                    <div class="explosion-zone">
                        <div class="explosion-text">üí• –í–ó–†–´–í</div>
                    </div>
                    <div class="plane-container" id="planeContainer">
                        <div class="plane" id="plane">‚úàÔ∏è</div>
                        <div class="multiplier-display" id="planeMultiplier">1.00x</div>
                    </div>
                    <div class="takeoff-zone">
                        <div class="takeoff-text">üõ´ –í–ó–õ–ï–¢</div>
                    </div>
                </div>

                <div class="multiplier-history">
                    <h5>üìä –ò—Å—Ç–æ—Ä–∏—è –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π:</h5>
                    <div class="history-list" id="multiplierHistory">
                        <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
let gameActive = false;
let currentMultiplier = 1.00;
let currentBet = 100;
let gameInterval = null;

// –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∑—Ä—ã–≤–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º)
function getExplosionChance() {
    // –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤–∑—Ä—ã–≤–∞ —Ä–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º
    // –ù–∞ 1x: 0.1%, –Ω–∞ 2x: 1%, –Ω–∞ 5x: 10%, –Ω–∞ 10x: 30%
    const baseChance = 0.001; // 0.1% –±–∞–∑–æ–≤–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
    const growthFactor = 0.3; // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Ä–æ—Å—Ç–∞

    return baseChance * Math.exp(growthFactor * (currentMultiplier - 1));
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateBalance();
    updatePotentialWin();
});

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–≤–∫–æ–π
function changeBet(amount) {
    currentBet = parseInt(document.getElementById('betAmount').value) + amount;
    if (currentBet < 10) currentBet = 10;
    if (currentBet > 10000000) currentBet = 10000000; // –ú–∞–∫—Å–∏–º—É–º 10M UC
    document.getElementById('betAmount').value = currentBet;
    updatePotentialWin();
}

function setBet(amount) {
    currentBet = amount;
    if (currentBet > 10000000) currentBet = 10000000; // –ú–∞–∫—Å–∏–º—É–º 10M UC
    document.getElementById('betAmount').value = currentBet;
    updatePotentialWin();
}

function updateBetDisplay() {
    document.getElementById('betAmount').value = currentBet;
    updatePotentialWin();
}

function updatePotentialWin() {
    const potentialWin = Math.floor(currentBet * currentMultiplier);
    document.getElementById('potentialWin').textContent = potentialWin.toLocaleString() + ' UC';
}

// –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã
function startGame() {
    // –ó–≤—É–∫ –∑–∞–ø—É—Å–∫–∞ —Å–∞–º–æ–ª–µ—Ç–∞
    playSound('planeStartSound');

    if (gameActive) return;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
    updateBalance().then(userBalance => {
        if (userBalance < currentBet) {
            showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ UC –¥–ª—è —Å—Ç–∞–≤–∫–∏!', 'error');
            return;
        }

        // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É —Å –±–∞–ª–∞–Ω—Å–∞
        fetch('/api/plane_bet', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({amount: currentBet})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–≥—Ä—É
                resetGame();
                gameActive = true;

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('startGameBtn').disabled = true;
                document.getElementById('cashoutBtn').disabled = false;

                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                startPlaneAnimation();

                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                updateBalance();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏!', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Å—Ç–∞–≤–∫–∏!', 'error');
        });
    });
}

function cashout() {

    playSound('planeCashoutSound');

    if (!gameActive) return;

    // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
    const winAmount = Math.floor(currentBet * currentMultiplier);

    // –ó–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à –Ω–∞ –±–∞–ª–∞–Ω—Å
    fetch('/api/plane_win', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({amount: winAmount})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            endGame(true);
            showNotification(`üéâ –í—ã —É—Å–ø–µ–ª–∏ –≤—ã–≤–µ—Å—Ç–∏ ${winAmount.toLocaleString()} UC!`);
            addToHistory(currentMultiplier, true);
            updateBalance();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ –≤—ã–∏–≥—Ä—ã—à–∞!', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–∏ –≤—ã–∏–≥—Ä—ã—à–∞!', 'error');
    });
}

function endGame(win = false) {

    playSound('planeCrashSound');

    gameActive = false;
    clearInterval(gameInterval);

    document.getElementById('startGameBtn').disabled = false;
    document.getElementById('cashoutBtn').disabled = true;

    if (!win) {
        showNotification('üí• –°–∞–º–æ–ª–µ—Ç –≤–∑–æ—Ä–≤–∞–ª—Å—è! –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ —Å—Ç–∞–≤–∫—É.', 'error');
        addToHistory(currentMultiplier, false);
    }
}

function resetGame() {
    currentMultiplier = 1.00;
    document.getElementById('currentMultiplier').textContent = '1.00x';
    document.getElementById('planeMultiplier').textContent = '1.00x';
    document.getElementById('planeContainer').style.left = '0%';
    document.getElementById('planeContainer').innerHTML = `
        <div class="plane">‚úàÔ∏è</div>
        <div class="multiplier-display" id="planeMultiplier">1.00x</div>
    `;
    updatePotentialWin();
}

function startPlaneAnimation() {
    const planeContainer = document.getElementById('planeContainer');
    let position = 0;

    gameInterval = setInterval(() => {
        if (!gameActive) return;

        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å
        currentMultiplier += 0.01;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≤–∑—Ä—ã–≤
        const explosionChance = getExplosionChance();
        if (Math.random() < explosionChance) {
            // –í–∑—Ä—ã–≤!
            planeContainer.innerHTML = '<div class="explosion">üí•</div>';
            endGame(false);
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∞–º–æ–ª–µ—Ç–∞ (–Ω–µ–ª–∏–Ω–µ–π–Ω–æ –¥–ª—è –±–æ–ª—å—à–µ–π –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏)
        const progress = Math.min(1, (currentMultiplier - 1) / 10); // –ú–∞–∫—Å 10x
        position = Math.pow(progress, 0.7) * 85; // –ù–µ–ª–∏–Ω–µ–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ

        planeContainer.style.left = position + '%';

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è
        const multiplierText = currentMultiplier.toFixed(2) + 'x';
        document.getElementById('currentMultiplier').textContent = multiplierText;
        document.getElementById('planeMultiplier').textContent = multiplierText;
        updatePotentialWin();

    }, 100); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 100ms
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function updateBalance() {
    return fetch('/api/get_user_info')
        .then(response => response.json())
        .then(data => {
            document.getElementById('gameBalance').textContent = data.balance.toLocaleString() + ' UC';
            return data.balance;
        });
}

function addToHistory(multiplier, won) {
    const historyList = document.getElementById('multiplierHistory');
    const historyItem = document.createElement('div');
    historyItem.className = 'history-item ' + (won ? 'history-won' : 'history-lost');
    historyItem.innerHTML = won ?
        `‚úÖ ${multiplier.toFixed(2)}x` :
        `üí• ${multiplier.toFixed(2)}x`;

    historyList.insertBefore(historyItem, historyList.firstChild);

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 10 –∑–∞–ø–∏—Å—è–º–∏
    if (historyList.children.length > 10) {
        historyList.removeChild(historyList.lastChild);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.getElementById('betAmount').addEventListener('change', function() {
    currentBet = parseInt(this.value) || 100;
    if (currentBet < 10) currentBet = 10;
    if (currentBet > 10000000) currentBet = 10000000; // –ú–∞–∫—Å–∏–º—É–º 10M UC
    this.value = currentBet;
    updatePotentialWin();
});
</script>

<style>
.plane-game-container {
    padding: 20px;
}

.game-info-sidebar {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    position: sticky;
    top: 20px;
}

.game-rules p {
    color: #b19cd9;
    margin-bottom: 10px;
    font-size: 14px;
}

.text-warning {
    color: #ffc107 !important;
    font-weight: bold;
}

.bet-controls {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
}

.bet-amount-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.bet-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #8a2be2;
    border-radius: 5px;
    color: white;
    padding: 8px;
    text-align: center;
    width: 100px;
}

.btn-bet-control {
    background: rgba(138, 43, 226, 0.5);
    border: 1px solid #8a2be2;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
}

.bet-presets {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.btn-bet-preset {
    background: rgba(138, 43, 226, 0.3);
    border: 1px solid #8a2be2;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    flex: 1;
}

.game-controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn-start-game {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 16px;
}

.btn-cashout {
    background: linear-gradient(45deg, #ffc107, #fd7e14);
    border: none;
    color: white;
    padding: 15px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 16px;
}

.btn-start-game:disabled, .btn-cashout:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.game-stats {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    color: white;
}

.stat-item span:last-child {
    color: #ffd700;
    font-weight: bold;
}

/* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
.game-field {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    height: 500px;
}

.plane-track {
    height: 300px;
    background: linear-gradient(90deg, #1a1a1a, #2d1b69, #1a1a1a);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    position: relative;
    margin-bottom: 20px;
    overflow: hidden;
}

.explosion-zone {
    position: absolute;
    right: 0;
    top: 0;
    width: 15%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(220, 53, 69, 0.3));
    display: flex;
    align-items: center;
    justify-content: center;
}

.takeoff-zone {
    position: absolute;
    left: 0;
    top: 0;
    width: 15%;
    height: 100%;
    background: linear-gradient(90deg, rgba(40, 167, 69, 0.3), transparent);
    display: flex;
    align-items: center;
    justify-content: center;
}

.explosion-text, .takeoff-text {
    color: white;
    font-weight: bold;
    transform: rotate(90deg);
}

.plane-container {
    position: absolute;
    top: 50%;
    left: 0%;
    transform: translateY(-50%);
    transition: left 0.1s linear;
}

.plane {
    font-size: 40px;
    text-align: center;
}

.multiplier-display {
    background: rgba(0, 0, 0, 0.7);
    color: #ffd700;
    padding: 5px 10px;
    border-radius: 15px;
    font-weight: bold;
    text-align: center;
    margin-top: 5px;
    border: 1px solid #ffd700;
}

.explosion {
    font-size: 50px;
    animation: explode 0.5s ease;
}

@keyframes explode {
    0% { transform: scale(1); }
    50% { transform: scale(1.5); }
    100% { transform: scale(1); }
}

.multiplier-history {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
}

.history-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.history-item {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
}

.history-won {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
}

.history-lost {
    background: linear-gradient(45deg, #dc3545, #fd7e14);
    color: white;
}
</style>
{% endblock %}