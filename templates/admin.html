{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <h1 class="text-center mb-4">üëë –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h1>

    <div class="row">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
        <div class="col-md-6">
            <div class="admin-section">
                <h4>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
                
                <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="search-section mb-3">
                    <input type="text" class="form-control" id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." 
                           oninput="searchUsers(this.value)">
                    <div class="users-list" id="usersList">
                        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º -->
                <div class="balance-control mb-4">
                    <h5>üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</h5>
                    <div class="row">
                        <div class="col-8">
                            <input type="number" class="form-control" id="balanceAmount" placeholder="–°—É–º–º–∞ UC" min="0">
                        </div>
                        <div class="col-4">
                            <button class="btn btn-success w-100" onclick="setBalance()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    <div class="btn-group w-100 mt-2">
                        <button class="btn btn-primary" onclick="addBalance(100)">+100</button>
                        <button class="btn btn-primary" onclick="addBalance(1000)">+1000</button>
                        <button class="btn btn-primary" onclick="addBalance(10000)">+10000</button>
                    </div>
                </div>

                <!-- –í—ã–¥–∞—á–∞ —Å–∫–∏–Ω–æ–≤ -->
                <div class="skin-control mb-4">
                    <h5>üéÅ –í—ã–¥–∞—á–∞ —Å–∫–∏–Ω–æ–≤</h5>
                    <select class="form-control mb-2" id="skinSelect">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω</option>
                        <!-- –°–∫–∏–Ω—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                    </select>
                    <button class="btn btn-warning w-100" onclick="giveSkin()">–í—ã–¥–∞—Ç—å —Å–∫–∏–Ω</button>
                </div>

                <!-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="ban-control mb-4">
                    <h5>üî® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h5>
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-danger" onclick="banUser()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-success" onclick="unbanUser()">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <button class="btn btn-dark w-100" onclick="deleteUser()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                </div>

                <!-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                <div class="test-users mb-4">
                    <h5>üß™ –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
                    <button class="btn btn-info w-100" onclick="createTestUsers()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
        <div class="col-md-6">
            <div class="admin-section">
                <h4>‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h4>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã -->
                <div class="stats-section mb-4">
                    <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h5>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                            <span id="totalUsers">0</span>
                        </div>
                        <div class="stat-card">
                            <span>–í—Å–µ–≥–æ —Å–∫–∏–Ω–æ–≤</span>
                            <span id="totalSkins">0</span>
                        </div>
                        <div class="stat-card">
                            <span>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</span>
                            <span id="totalBalance">0 UC</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary w-100 mt-2" onclick="loadSystemStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>

                <!-- –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
                <div class="bulk-actions mb-4">
                    <h5>üéØ –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h5>
                    <button class="btn btn-info w-100 mb-2" onclick="giveAllBonus(100)">–í—ã–¥–∞—Ç—å –≤—Å–µ–º +100 UC</button>
                    <button class="btn btn-info w-100 mb-2" onclick="giveAllBonus(500)">–í—ã–¥–∞—Ç—å –≤—Å–µ–º +500 UC</button>
                    <button class="btn btn-danger w-100 mb-2" onclick="resetAllInventories()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏</button>
                    <button class="btn btn-success w-100" onclick="generateDailyRewards()">üéÅ –í—ã–¥–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã</button>
                </div>

                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ–π—Å–∞–º–∏ -->
                <div class="case-control mb-4">
                    <h5>üéÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ–π—Å–∞–º–∏</h5>
                    <select class="form-control mb-2" id="caseSelect">
                        <option value="1">–ë–∞–∑–æ–≤—ã–π –ö–µ–π—Å (100 UC)</option>
                        <option value="2">–ü—Ä–µ–º–∏—É–º –ö–µ–π—Å (500 UC)</option>
                        <option value="3">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ö–µ–π—Å (1000 UC)</option>
                    </select>
                    <button class="btn btn-primary w-100" onclick="modifyCaseChances()">–ò–∑–º–µ–Ω–∏—Ç—å —à–∞–Ω—Å—ã</button>
                </div>

                <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
                <div class="export-section">
                    <h5>üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                    <button class="btn btn-secondary w-100 mb-2" onclick="exportUsers()">–≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</button>
                    <button class="btn btn-secondary w-100" onclick="exportTransactions()">–≠–∫—Å–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="admin-section mt-4">
        <h4>üìù –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</h4>
        <div class="logs-container" id="actionLogs">
            <div class="log-entry">
                <span class="log-time">{{ now.strftime('%H:%M:%S') if now else '' }}</span>
                <span class="log-message">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>
            </div>
        </div>
        <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>
</div>

<script>
let allUsers = [];
let allSkins = [];
let selectedUserId = null;
let selectedUserName = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadAllUsers();
    loadAllSkins();
    loadSystemStats();
    addToLog('–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function loadAllUsers() {
    fetch('/api/admin/get_users')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.users && Array.isArray(data.users)) {
                allUsers = data.users;
                displayUsers(allUsers);
                addToLog('–ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            } else {
                throw new Error('Invalid data format: users array not found');
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message, 'error');
            addToLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–∫–∏–Ω–æ–≤
function loadAllSkins() {
    fetch('/api/admin/get_all_skins')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.skins && Array.isArray(data.skins)) {
                allSkins = data.skins;
                populateSkinSelect();
                addToLog('–ó–∞–≥—Ä—É–∂–µ–Ω —Å–ø–∏—Å–æ–∫ —Å–∫–∏–Ω–æ–≤');
            } else {
                throw new Error('Invalid data format: skins array not found');
            }
        })
        .catch(error => {
            console.error('Error loading skins:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤', 'error');
            addToLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–Ω–æ–≤: ' + error.message);
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
function loadSystemStats() {
    fetch('/api/admin/system_stats')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.total_users !== undefined && data.total_skins !== undefined && data.total_balance !== undefined) {
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('totalSkins').textContent = data.total_skins;
                document.getElementById('totalBalance').textContent = data.total_balance.toLocaleString() + ' UC';
                addToLog('–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã');
            } else {
                throw new Error('Invalid stats data');
            }
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            addToLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
        });
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function searchUsers(query) {
    if (!query) {
        displayUsers(allUsers);
        return;
    }

    const filteredUsers = allUsers.filter(user =>
        user.username.toLowerCase().includes(query.toLowerCase())
    );
    displayUsers(filteredUsers);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function displayUsers(users) {
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';

    if (!users || !Array.isArray(users) || users.length === 0) {
        usersList.innerHTML = '<div class="text-center p-3 text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
    }

    users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = `user-item ${selectedUserId === user.id ? 'selected' : ''}`;
        userElement.onclick = () => selectUser(user);
        userElement.innerHTML = `
            <div class="user-info">
                <strong>${user.username}</strong>
                <span class="user-balance">${user.balance} UC</span>
            </div>
            <div class="user-stats">
                <small>–°–∫–∏–Ω–æ–≤: ${user.skin_count || 0}</small>
                <small class="${user.is_banned ? 'text-danger' : 'text-success'}">
                    ${user.is_banned ? 'üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : 'üü¢ –ê–∫—Ç–∏–≤–µ–Ω'}
                </small>
            </div>
        `;
        usersList.appendChild(userElement);
    });
}

// –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function selectUser(user) {
    selectedUserId = user.id;
    selectedUserName = user.username;
    displayUsers(allUsers);
    addToLog(`–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.username} (ID: ${user.id})`);
}

// –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Å–∫–∏–Ω–æ–≤
function populateSkinSelect() {
    const skinSelect = document.getElementById('skinSelect');
    skinSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω</option>';

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–∫–∏–Ω—ã –ø–æ —Ü–µ–Ω–µ
    const sortedSkins = allSkins.sort((a, b) => b.price - a.price);

    sortedSkins.forEach(skin => {
        const option = document.createElement('option');
        option.value = skin.id;
        option.textContent = `${skin.name} - ${skin.price} UC (${skin.rarity})`;
        skinSelect.appendChild(option);
    });
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–ª–∞–Ω—Å–∞
function setBalance() {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    const amount = parseInt(document.getElementById('balanceAmount').value);
    if (!amount || amount < 0) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É!', 'error');
        return;
    }

    fetch('/api/admin/set_balance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId,
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–ë–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${amount} UC –¥–ª—è ${selectedUserName}`);
            addToLog(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –±–∞–ª–∞–Ω—Å ${amount} UC –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${selectedUserName}`);
            loadAllUsers();
            document.getElementById('balanceAmount').value = '';
        } else {
            showNotification('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞', 'error');
        addToLog('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–ª–∞–Ω—Å–∞: ' + error.message);
    });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
function addBalance(amount) {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    fetch('/api/admin/add_balance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId,
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} UC –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${selectedUserName}`);
            addToLog(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${amount} UC –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ${selectedUserName}`);
            loadAllUsers();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞', 'error');
        addToLog('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞: ' + error.message);
    });
}

// –í—ã–¥–∞—á–∞ —Å–∫–∏–Ω–∞
function giveSkin() {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    const skinId = document.getElementById('skinSelect').value;
    if (!skinId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–∏–Ω!', 'error');
        return;
    }

    const skin = allSkins.find(s => s.id == skinId);
    if (!skin) {
        showNotification('–°–∫–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        return;
    }

    fetch('/api/admin/give_skin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId,
            skin_id: parseInt(skinId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–°–∫–∏–Ω "${skin.name}" –≤—ã–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${selectedUserName}`);
            addToLog(`–í—ã–¥–∞–Ω —Å–∫–∏–Ω "${skin.name}" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ${selectedUserName}`);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —Å–∫–∏–Ω–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —Å–∫–∏–Ω–∞', 'error');
        addToLog('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —Å–∫–∏–Ω–∞: ' + error.message);
    });
}

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function banUser() {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    if (!confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${selectedUserName}?`)) {
        return;
    }

    fetch('/api/admin/ban_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedUserName} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
            addToLog(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${selectedUserName}`);
            loadAllUsers();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        addToLog('–û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
    });
}

// –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function unbanUser() {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    fetch('/api/admin/unban_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedUserName} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
            addToLog(`–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${selectedUserName}`);
            loadAllUsers();
        } else {
            showNotification('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        addToLog('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function deleteUser() {
    if (!selectedUserId) {
        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'error');
        return;
    }

    if (!confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${selectedUserName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        return;
    }

    fetch('/api/admin/delete_user', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            user_id: selectedUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${selectedUserName} —É–¥–∞–ª–µ–Ω!`);
            addToLog(`–£–¥–∞–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${selectedUserName}`);
            selectedUserId = null;
            selectedUserName = null;
            loadAllUsers();
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        addToLog('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function createTestUsers() {
    if (!confirm('–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?')) {
        return;
    }

    fetch('/api/admin/create_test_users', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–°–æ–∑–¥–∞–Ω–æ ${data.created_count} —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
            addToLog(`–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.created_count}`);
            loadAllUsers();
        } else {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
        addToLog('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
    });
}

// –ú–∞—Å—Å–æ–≤–∞—è –≤—ã–¥–∞—á–∞ –±–æ–Ω—É—Å–∞
function giveAllBonus(amount) {
    if (!confirm(`–í—ã–¥–∞—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ ${amount} UC?`)) {
        return;
    }

    fetch('/api/admin/give_all_bonus', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            amount: amount
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤—ã–¥–∞–Ω–æ –ø–æ ${amount} UC!`);
            addToLog(`–ú–∞—Å—Å–æ–≤–∞—è –≤—ã–¥–∞—á–∞ ${amount} UC –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
            loadAllUsers();
            loadSystemStats();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≤—ã–¥–∞—á–∏ –±–æ–Ω—É—Å–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≤—ã–¥–∞—á–∏ –±–æ–Ω—É—Å–∞', 'error');
        addToLog('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≤—ã–¥–∞—á–∏ –±–æ–Ω—É—Å–∞: ' + error.message);
    });
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π
function resetAllInventories() {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï! –û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        return;
    }

    fetch('/api/admin/reset_all_inventories', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–í—Å–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –æ—á–∏—â–µ–Ω—ã!');
            addToLog('–û—á–∏—â–µ–Ω—ã –≤—Å–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            loadSystemStats();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π', 'error');
        addToLog('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π: ' + error.message);
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥
function generateDailyRewards() {
    if (!confirm('–í—ã–¥–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?')) {
        return;
    }

    fetch('/api/admin/generate_daily_rewards', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –≤—ã–¥–∞–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!');
            addToLog('–í—ã–¥–∞–Ω—ã –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–≥—Ä–∞–¥—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º');
            loadAllUsers();
            loadSystemStats();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥', 'error');
        addToLog('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥: ' + error.message);
    });
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∞–Ω—Å–æ–≤ –∫–µ–π—Å–æ–≤
function modifyCaseChances() {
    const caseId = document.getElementById('caseSelect').value;
    showNotification('–§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —à–∞–Ω—Å–æ–≤ –∫–µ–π—Å–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'error');
    addToLog('–ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —à–∞–Ω—Å–æ–≤ –∫–µ–π—Å–∞ ID: ' + caseId);
}

// –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function exportUsers() {
    fetch('/api/admin/export_users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥–æ—Ç–æ–≤—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                addToLog('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                console.log('Users data:', data.data);
            } else {
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            addToLog('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
        });
}

// –≠–∫—Å–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
function exportTransactions() {
    fetch('/api/admin/export_transactions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–î–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≥–æ—Ç–æ–≤—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                addToLog('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
            } else {
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', 'error');
            addToLog('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ' + error.message);
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
function loadSystemStats() {
    fetch('/api/admin/system_stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('totalSkins').textContent = data.total_skins;
            document.getElementById('totalBalance').textContent = data.total_balance.toLocaleString() + ' UC';
            addToLog('–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã');
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            addToLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
        });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∞ –¥–µ–π—Å—Ç–≤–∏–π
function addToLog(message) {
    const logsContainer = document.getElementById('actionLogs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-time">${new Date().toLocaleTimeString()}</span>
        <span class="log-message">${message}</span>
    `;
    logsContainer.insertBefore(logEntry, logsContainer.firstChild);
}

// –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
function clearLogs() {
    const logsContainer = document.getElementById('actionLogs');
    logsContainer.innerHTML = '<div class="log-entry"><span class="log-time">' + new Date().toLocaleTimeString() + '</span><span class="log-message">–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã</span></div>';
}
</script>

<style>
.admin-container {
    padding: 20px;
}

.admin-section {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.search-section {
    position: relative;
}

.users-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #8a2be2;
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.3);
}

.user-item {
    padding: 10px;
    border-bottom: 1px solid #8a2be2;
    cursor: pointer;
    transition: all 0.3s ease;
}

.user-item:hover {
    background: rgba(138, 43, 226, 0.2);
}

.user-item.selected {
    background: rgba(138, 43, 226, 0.4);
    border-left: 4px solid #ffd700;
}

.user-item:last-child {
    border-bottom: none;
}

.user-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.user-balance {
    color: #ffd700;
    font-weight: bold;
}

.user-stats {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #b19cd9;
    margin-top: 5px;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

.stat-card {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #8a2be2;
}

.stat-card span:first-child {
    display: block;
    color: #b19cd9;
    font-size: 12px;
    margin-bottom: 5px;
}

.stat-card span:last-child {
    display: block;
    color: #ffd700;
    font-weight: bold;
    font-size: 18px;
}

.logs-container {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #8a2be2;
    border-radius: 8px;
    padding: 10px;
}

.log-entry {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #8a2be2;
    font-size: 12px;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-time {
    color: #ffd700;
    font-weight: bold;
    min-width: 80px;
}

.log-message {
    color: #b19cd9;
    flex: 1;
    margin-left: 10px;
}

.btn-group .btn {
    margin: 0 2px;
}

.text-danger { color: #dc3545 !important; }
.text-success { color: #28a745 !important; }
.text-muted { color: #6c757d !important; }
</style>
{% endblock %}