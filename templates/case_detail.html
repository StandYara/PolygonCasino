{% extends "base.html" %}

{% block content %}
<div class="case-detail-container">
    <div class="row">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–µ–π—Å–µ -->
        <div class="col-md-4">
            <div class="case-info-sidebar">
                <div class="case-image mb-3">
                    <img src="https://via.placeholder.com/300x200/2d1b69/ffffff?text=–ö–µ–π—Å+{{ case_id }}" class="img-fluid" alt="–ö–µ–π—Å {{ case_id }}">
                </div>
                <h2 id="caseTitle">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ JS -->
                </h2>
                <p class="case-description" id="caseDescription">
                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ JS -->
                </p>
                <div class="case-price-large">
                    <span class="uc-price" id="casePrice">
                        <!-- –¶–µ–Ω–∞ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JS -->
                    </span>
                </div>

                <!-- –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ -->
                <div class="free-case-info" id="freeCaseInfo" style="display: none;">
                    <div class="availability-status" id="availabilityStatus"></div>
                    <small class="text-muted" id="freeCaseHint"></small>
                </div>

                <button class="btn btn-open-case" id="openCaseBtn">–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>

                <!-- –®–∞–Ω—Å—ã -->
                <div class="chances-list mt-4">
                    <h5>üé∞ –®–∞–Ω—Å—ã –≤—ã–ø–∞–¥–µ–Ω–∏—è:</h5>
                    <div id="chancesList">
                        <!-- –®–∞–Ω—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>

                <div class="case-value mt-4">
                    <h5>üí∞ –¶–µ–Ω–Ω–æ—Å—Ç—å –∫–µ–π—Å–∞:</h5>
                    <div class="value-info" id="valueInfo">
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - —Ä—É–ª–µ—Ç–∫–∞ -->
        <div class="col-md-8">
            <div class="roulette-container">
                <h3 class="text-center mb-4">üé° –†—É–ª–µ—Ç–∫–∞</h3>
                <div class="roulette-wrapper">
                    <div class="roulette-wheel" id="rouletteWheel">
                        <!-- –°–∫–∏–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JS -->
                    </div>
                    <div class="roulette-pointer"></div>
                </div>
                <div id="result" class="mt-4 text-center"></div>
            </div>
        </div>
    </div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –æ –∫–µ–π—Å–∞—Ö
const caseData = {
    // –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–µ–π—Å—ã
    1: {
        title: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ö–µ–π—Å',
        description: '–û–±—ã—á–Ω—ã–µ —Å–∫–∏–Ω—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã',
        price: 0,
        chances: { common: 95, rare: 5, epic: 0, legendary: 0, mythical: 0, ancient: 0 },
        value: { avg: 45, roi: 45 },
        type: 'free',
        limitation: '1 —Ä–∞–∑ –≤ –¥–µ–Ω—å'
    },
    2: {
        title: '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –ö–µ–π—Å',
        description: '–ü–æ–¥–∞—Ä–æ–∫ –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤',
        price: 0,
        chances: { common: 95, rare: 5, epic: 0, legendary: 0, mythical: 0, ancient: 0 },
        value: { avg: 45, roi: 45 },
        type: 'free',
        limitation: '–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤'
    },
    3: {
        title: '–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ë–æ–Ω—É—Å',
        description: '–ù–∞–≥—Ä–∞–¥–∞ –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤—Ö–æ–¥',
        price: 0,
        chances: { common: 95, rare: 5, epic: 0, legendary: 0, mythical: 0, ancient: 0 },
        value: { avg: 45, roi: 45 },
        type: 'free',
        limitation: '–ó–∞ –≤—Ö–æ–¥ 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥'
    },

    // –î–ª—è –Ω–æ–≤–∏—á–∫–æ–≤
    4: {
        title: '–ë–∞–∑–æ–≤—ã–π –ö–µ–π—Å',
        description: '–û—Ç–ª–∏—á–Ω–æ–µ –Ω–∞—á–∞–ª–æ –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤',
        price: 50,
        chances: { common: 80, rare: 18, epic: 2, legendary: 0, mythical: 0, ancient: 0 },
        value: { avg: 32, roi: 65 },
        type: 'starter'
    },
    5: {
        title: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π –ö–µ–π—Å',
        description: '–ü–µ—Ä–≤—ã–π —à–∞–≥ –∫ –±–æ–ª—å—à–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏',
        price: 100,
        chances: { common: 70, rare: 25, epic: 5, legendary: 0, mythical: 0, ancient: 0 },
        value: { avg: 70, roi: 70 },
        type: 'starter'
    },
    6: {
        title: '–ö–µ–π—Å –£—á–µ–Ω–∏–∫–∞',
        description: '–î–ª—è —Ç–µ—Ö, –∫—Ç–æ –æ—Å–≤–∞–∏–≤–∞–µ—Ç –∞–∑—ã',
        price: 200,
        chances: { common: 60, rare: 30, epic: 9, legendary: 1, mythical: 0, ancient: 0 },
        value: { avg: 150, roi: 75 },
        type: 'starter'
    },

    // –ü—Ä–µ–º–∏—É–º –∫–µ–π—Å—ã
    7: {
        title: '–ü—Ä–µ–º–∏—É–º –ö–µ–π—Å',
        description: '–†–µ–¥–∫–∏–µ –∏ —ç–ø–∏—á–µ—Å–∫–∏–µ —Å–∫–∏–Ω—ã',
        price: 500,
        chances: { common: 40, rare: 45, epic: 12, legendary: 3, mythical: 0, ancient: 0 },
        value: { avg: 400, roi: 80 },
        type: 'premium'
    },
    8: {
        title: '–ó–æ–ª–æ—Ç–æ–π –ö–µ–π—Å',
        description: '–ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã',
        price: 1000,
        chances: { common: 30, rare: 40, epic: 20, legendary: 9, mythical: 1, ancient: 0 },
        value: { avg: 850, roi: 85 },
        type: 'premium'
    },
    9: {
        title: '–ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π –ö–µ–π—Å',
        description: '–≠–ª–∏—Ç–Ω—ã–µ —Å–∫–∏–Ω—ã –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞',
        price: 2000,
        chances: { common: 20, rare: 35, epic: 30, legendary: 13, mythical: 2, ancient: 0 },
        value: { avg: 1800, roi: 90 },
        type: 'premium'
    },

    // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –∫–µ–π—Å—ã
    10: {
        title: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –ö–µ–π—Å',
        description: '–®–∞–Ω—Å –Ω–∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã',
        price: 5000,
        chances: { common: 10, rare: 25, epic: 40, legendary: 20, mythical: 4, ancient: 1 },
        value: { avg: 4750, roi: 95 },
        type: 'legendary'
    },
    11: {
        title: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –ö–µ–π—Å',
        description: '–†–µ–¥—á–∞–π—à–∏–µ —Å–∫–∏–Ω—ã –≤ –∏–≥—Ä–µ',
        price: 10000,
        chances: { common: 5, rare: 15, epic: 35, legendary: 30, mythical: 12, ancient: 3 },
        value: { avg: 11000, roi: 110 },
        type: 'legendary'
    },
    12: {
        title: '–î—Ä–µ–≤–Ω–∏–π –ö–µ–π—Å',
        description: '–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π —Å–∏–ª—ã',
        price: 25000,
        chances: { common: 2, rare: 8, epic: 25, legendary: 40, mythical: 20, ancient: 5 },
        value: { avg: 37500, roi: 150 },
        type: 'legendary'
    },

    // –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–µ–π—Å—ã
    13: {
        title: '–ó–∞–≥–∞–¥–æ—á–Ω—ã–π –ö–µ–π—Å',
        description: '–°–æ–¥–µ—Ä–∂–∏—Ç —Å–ª—É—á–∞–π–Ω—ã–µ —Å—é—Ä–ø—Ä–∏–∑—ã',
        price: 1500,
        chances: { common: 50, rare: 30, epic: 15, legendary: 4, mythical: 1, ancient: 0 },
        value: { avg: 1050, roi: 70 },
        type: 'secret'
    },
    14: {
        title: '–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ö–µ–π—Å',
        description: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ',
        price: 3000,
        chances: { common: 40, rare: 25, epic: 20, legendary: 10, mythical: 4, ancient: 1 },
        value: { avg: 1500, roi: 50 },
        type: 'secret'
    },
    15: {
        title: '–ó–∞–ø—Ä–µ—Ç–Ω—ã–π –ö–µ–π—Å',
        description: '–¢–æ–ª—å–∫–æ –¥–ª—è —Å–º–µ–ª—ã—Ö –∏–≥—Ä–æ–∫–æ–≤',
        price: 7500,
        chances: { common: 30, rare: 20, epic: 25, legendary: 15, mythical: 8, ancient: 2 },
        value: { avg: 2250, roi: 30 },
        type: 'secret'
    },

    // VIP –∫–µ–π—Å—ã
    16: {
        title: 'VIP –ó–æ–ª–æ—Ç–æ–π',
        description: '–≠–ª–∏—Ç–Ω—ã–µ —Å–∫–∏–Ω—ã –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö',
        price: 15000,
        chances: { common: 0, rare: 20, epic: 40, legendary: 30, mythical: 8, ancient: 2 },
        value: { avg: 16500, roi: 110 },
        type: 'vip'
    },
    17: {
        title: 'VIP –ë—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤—ã–π',
        description: '–ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ —Ä–µ–¥–∫–∏–µ —Å–∫–∏–Ω—ã',
        price: 50000,
        chances: { common: 0, rare: 10, epic: 30, legendary: 40, mythical: 15, ancient: 5 },
        value: { avg: 60000, roi: 120 },
        type: 'vip'
    },
    18: {
        title: 'VIP –ü–ª–∞—Ç–∏–Ω–æ–≤—ã–π',
        description: '–ê–±—Å–æ–ª—é—Ç–Ω–∞—è —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å',
        price: 100000,
        chances: { common: 0, rare: 5, epic: 20, legendary: 45, mythical: 20, ancient: 10 },
        value: { avg: 130000, roi: 130 },
        type: 'vip'
    },

    // –•–µ–ª–ª–æ—É–∏–Ω—Å–∫–∏–µ –∫–µ–π—Å—ã
    19: {
        title: '–¢—ã–∫–≤–µ–Ω–Ω—ã–π –ö–µ–π—Å',
        description: '–ñ—É—Ç–∫–∏–µ —Å–∫–∏–Ω—ã –Ω–∞ –•–µ–ª–ª–æ—É–∏–Ω',
        price: 750,
        chances: { common: 35, rare: 40, epic: 20, legendary: 4, mythical: 1, ancient: 0 },
        value: { avg: 600, roi: 80 },
        type: 'halloween'
    },
    20: {
        title: '–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π –ö–µ–π—Å',
        description: '–ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã',
        price: 1500,
        chances: { common: 25, rare: 35, epic: 30, legendary: 8, mythical: 2, ancient: 0 },
        value: { avg: 1275, roi: 85 },
        type: 'halloween'
    },
    21: {
        title: '–í–∞–º–ø–∏—Ä—Å–∫–∏–π –ö–µ–π—Å',
        description: '–ö—Ä–æ–≤–∞–≤–æ-–∫—Ä–∞—Å–Ω—ã–µ —Å–∫–∏–Ω—ã',
        price: 3000,
        chances: { common: 15, rare: 30, epic: 35, legendary: 15, mythical: 4, ancient: 1 },
        value: { avg: 2700, roi: 90 },
        type: 'halloween'
    },

    // –ó–∏–º–Ω–∏–µ –∫–µ–π—Å—ã
    22: {
        title: '–°–Ω–µ–∂–Ω—ã–π –ö–µ–π—Å',
        description: '–ú–æ—Ä–æ–∑–Ω—ã–µ —Å–∫–∏–Ω—ã',
        price: 1000,
        chances: { common: 30, rare: 45, epic: 20, legendary: 4, mythical: 1, ancient: 0 },
        value: { avg: 800, roi: 80 },
        type: 'winter'
    },
    23: {
        title: '–õ–µ–¥—è–Ω–æ–π –ö–µ–π—Å',
        description: '–•–æ–ª–æ–¥–Ω—ã–µ —Å–∏–Ω–∏–µ —Å–∫–∏–Ω—ã',
        price: 2500,
        chances: { common: 20, rare: 40, epic: 30, legendary: 8, mythical: 2, ancient: 0 },
        value: { avg: 2125, roi: 85 },
        type: 'winter'
    },
    24: {
        title: '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –ö–µ–π—Å',
        description: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ —Å–∫–∏–Ω—ã',
        price: 5000,
        chances: { common: 10, rare: 35, epic: 35, legendary: 15, mythical: 4, ancient: 1 },
        value: { avg: 4500, roi: 90 },
        type: 'winter'
    }
};

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–µ–π—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const caseId = {{ case_id }};
    const caseInfo = caseData[caseId];

    if (!caseInfo) {
        showNotification('–ö–µ–π—Å –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
        return;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–µ–π—Å–µ
    document.getElementById('caseTitle').textContent = caseInfo.title;
    document.getElementById('caseDescription').textContent = caseInfo.description;

    // –¶–µ–Ω–∞ –∫–µ–π—Å–∞
    const priceElement = document.getElementById('casePrice');
    if (caseInfo.price === 0) {
        priceElement.textContent = '–ë–ï–°–ü–õ–ê–¢–ù–û';
        priceElement.className = 'uc-price free-price';
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –∫–µ–π—Å–µ
        document.getElementById('freeCaseInfo').style.display = 'block';
        checkFreeCaseAvailability(caseId);
    } else {
        priceElement.textContent = caseInfo.price.toLocaleString() + ' UC';
        priceElement.className = 'uc-price';
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —à–∞–Ω—Å—ã
    displayChances(caseInfo.chances);

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏
    displayValueInfo(caseInfo.value, caseInfo.price);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫–∏–Ω—ã –¥–ª—è —Ä—É–ª–µ—Ç–∫–∏
    loadCaseSkins(caseInfo.type);
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
function displayChances(chances) {
    const chancesList = document.getElementById('chancesList');
    chancesList.innerHTML = '';

    const rarityNames = {
        'common': '–û–±—ã—á–Ω—ã–π',
        'rare': '–†–µ–¥–∫–∏–π',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π',
        'mythical': '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π',
        'ancient': '–î—Ä–µ–≤–Ω–∏–π'
    };

    const rarityColors = {
        'common': 'common',
        'rare': 'rare',
        'epic': 'epic',
        'legendary': 'legendary',
        'mythical': 'mythical',
        'ancient': 'ancient'
    };

    for (const [rarity, percent] of Object.entries(chances)) {
        if (percent > 0) {
            const chanceItem = document.createElement('div');
            chanceItem.className = 'chance-item';
            chanceItem.innerHTML = `
                <span class="rarity ${rarityColors[rarity]}">${rarityNames[rarity]}</span>
                <span class="chance-percent">${percent}%</span>
            `;
            chancesList.appendChild(chanceItem);
        }
    }
}

function displayValueInfo(valueInfo, price) {
    const valueElement = document.getElementById('valueInfo');
    const roiClass = valueInfo.roi >= 100 ? 'text-success' :
                    valueInfo.roi >= 70 ? 'text-warning' : 'text-danger';

    valueElement.innerHTML = `
        <p>–°—Ä–µ–¥–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à: <strong>${valueInfo.avg.toLocaleString()} UC</strong></p>
        <p>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å: <strong class="${roiClass}">${valueInfo.roi}%</strong></p>
    `;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–µ–π—Å–∞
function checkFreeCaseAvailability(caseId) {
    fetch(`/api/check_free_case/${caseId}`)
        .then(response => response.json())
        .then(data => {
            const statusElement = document.getElementById('availabilityStatus');
            const hintElement = document.getElementById('freeCaseHint');
            const openBtn = document.getElementById('openCaseBtn');

            if (data.available) {
                statusElement.innerHTML = '<span class="text-success">‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è</span>';
                hintElement.textContent = data.hint || '–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!';
                openBtn.disabled = false;
            } else {
                statusElement.innerHTML = '<span class="text-danger">‚ùå –£–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–µ–≥–æ–¥–Ω—è</span>';
                hintElement.textContent = data.hint || '–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!';
                openBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error checking free case:', error);
        });
}

// –§—É–Ω–∫—Ü–∏–∏ —Ä—É–ª–µ—Ç–∫–∏ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
function loadCaseSkins(caseType) {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫–∏–Ω—ã –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∫–µ–π—Å–∞
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã fetch –∑–∞–ø—Ä–æ—Å
    const skins = getSkinsForCaseType(caseType);
    createRouletteWithTargetSkin(null, skins);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∫–æ—Å—Ç–µ–π
function getSkinRarity(skinPrice) {
    if (skinPrice <= 50) return 'common';
    if (skinPrice <= 300) return 'rare';
    if (skinPrice <= 1500) return 'epic';
    if (skinPrice <= 5000) return 'legendary';
    if (skinPrice <= 50000) return 'mythical';
    return 'ancient';
}

function getRarityName(rarity) {
    const names = {
        'common': '–û–±—ã—á–Ω—ã–π',
        'rare': '–†–µ–¥–∫–∏–π',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∏–π',
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π',
        'mythical': '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π',
        'ancient': '–î—Ä–µ–≤–Ω–∏–π'
    };
    return names[rarity] || '–û–±—ã—á–Ω—ã–π';
}

function getRarityColor(rarity) {
    const colors = {
        'common': '#6c757d',
        'rare': '#007bff',
        'epic': '#8a2be2',
        'legendary': '#ff6b6b',
        'mythical': '#ff00ff',
        'ancient': '#00ffff'
    };
    return colors[rarity] || '#6c757d';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentSkins = [];
const rouletteWheel = document.getElementById('rouletteWheel');
let isSpinning = false;
let currentWonSkin = null;

function createRouletteWithTargetSkin(targetSkin = null, skins = null) {
    rouletteWheel.innerHTML = '';

    if (skins && skins.length > 0) {
        currentSkins = skins;
    }

    console.log('Creating roulette with', currentSkins.length, 'skins');

    if (!currentSkins || currentSkins.length === 0) {
        console.error('No skins available for roulette');
        // –°–æ–∑–¥–∞–µ–º fallback —Å–∫–∏–Ω—ã
        currentSkins = getDemoSkins();
    }

    // –°–æ–∑–¥–∞–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    const totalItems = 50;

    for (let i = 0; i < totalItems; i++) {
        let skin;

        if (targetSkin && i === 25) { // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –¥–ª—è –≤—ã–∏–≥—Ä–∞–Ω–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
            skin = targetSkin;
        } else {
            skin = getRandomSkin(targetSkin);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π
        if (!skin || !skin.id) {
            console.warn('Invalid skin at position', i, skin);
            skin = getDemoSkins()[0]; // Fallback —Å–∫–∏–Ω
        }

        createRouletteItem(skin);
    }
}

// –£–ª—É—á—à–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–∫–∏–Ω–∞
function getRandomSkin(excludeSkin = null) {
    if (!currentSkins || currentSkins.length === 0) {
        return getDemoSkins()[0];
    }

    // –ï—Å–ª–∏ —Å–∫–∏–Ω–æ–≤ –º–∞–ª–æ, –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
    if (currentSkins.length <= 5) {
        return currentSkins[Math.floor(Math.random() * currentSkins.length)];
    }

    let randomSkin;
    let attempts = 0;
    const maxAttempts = 10;

    do {
        randomSkin = currentSkins[Math.floor(Math.random() * currentSkins.length)];
        attempts++;

        // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫, –±–µ—Ä–µ–º –ª—é–±–æ–π —Å–∫–∏–Ω
        if (attempts >= maxAttempts) {
            break;
        }

    } while (excludeSkin && randomSkin.id === excludeSkin.id);

    return randomSkin;
}

function createRouletteItem(skin) {
    const skinElement = document.createElement('div');
    skinElement.className = 'roulette-item';
    const rarity = getSkinRarity(skin.price);
    skinElement.innerHTML = `
        <img src="${skin.image}" alt="${skin.name}">
        <div class="skin-rarity ${rarity}">${getRarityName(rarity)}</div>
        <div class="skin-name">${skin.name}</div>
        <div class="skin-price-small">${skin.price.toLocaleString()} UC</div>
    `;
    rouletteWheel.appendChild(skinElement);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä—É–ª–µ—Ç–∫—É
createRouletteWithTargetSkin();

// –õ–æ–≥–∏–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
document.getElementById('openCaseBtn').addEventListener('click', function() {
    if (isSpinning) return;

    const btn = this;
    const resultDiv = document.getElementById('result');
    const caseId = {{ case_id }};
    const caseInfo = caseData[caseId];

    isSpinning = true;
    btn.disabled = true;
    btn.textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...';
    resultDiv.innerHTML = '';

    // –ó–≤—É–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
    playSound('caseOpenSound');

    // –î–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
    if (caseInfo.price === 0) {
        if (btn.disabled) {
            showNotification('–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å–µ–≥–æ–¥–Ω—è!', 'error');
            isSpinning = false;
            btn.disabled = false;
            btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';
            return;
        }
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ä—É–ª–µ—Ç–∫–∏
    rouletteWheel.style.transition = 'none';
    rouletteWheel.style.transform = 'translateX(0)';

    // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–∏–≥—Ä—ã—à–∞
    fetch(`/api/open_case/${caseId}`)
        .then(response => response.json())
        .then(wonSkin => {
            if (wonSkin.error) {
                showNotification(wonSkin.error, 'error');
                isSpinning = false;
                btn.disabled = false;
                btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';
                return;
            }

            currentWonSkin = wonSkin;

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ —à–∞–ø–∫–µ –ø–æ—Å–ª–µ —Å–ø–∏—Å–∞–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
            if (caseInfo.price > 0) {
                updateHeaderBalance();
            }

            // –ü–ï–†–ï–°–û–ó–î–ê–ï–ú –†–£–õ–ï–¢–ö–£ –° –í–´–ò–ì–†–ê–ù–ù–´–ú –°–ö–ò–ù–û–ú –í –¶–ï–õ–ï–í–û–ô –ü–û–ó–ò–¶–ò–ò
            createRouletteWithTargetSkin(wonSkin);

            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É DOM
            setTimeout(() => {
                // –ó–≤—É–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Ä—É–ª–µ—Ç–∫–∏
                playSound('caseRollSound');

                // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ü–µ–ª–µ–≤–æ–π —Å–∫–∏–Ω)
                const skinWidth = 170;
                const targetPosition = 25;
                const stopPosition = -(targetPosition * skinWidth - 2 * skinWidth);
                const extraMovement = 5000;
                const finalPosition = stopPosition - extraMovement;

                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                rouletteWheel.style.transition = 'transform 5s cubic-bezier(0.1, 0.1, 0.1, 1)';
                rouletteWheel.style.transform = `translateX(${finalPosition}px)`;

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                const checkAndAddItems = () => {
                    const currentTransform = rouletteWheel.style.transform;
                    const currentX = parseInt(currentTransform.match(/translateX\(([-\d]+)px/)[1]) || 0;
                    const totalWidth = rouletteWheel.scrollWidth;
                    const visibleWidth = document.querySelector('.roulette-wrapper').clientWidth;

                    if (Math.abs(currentX) > totalWidth - visibleWidth * 2) {
                        addMoreItems();
                    }
                };

                function addMoreItems() {
                    const additionalItems = 20;
                    for (let i = 0; i < additionalItems; i++) {
                        const skin = getRandomSkin(currentWonSkin);
                        createRouletteItem(skin);
                    }
                }

                const checkInterval = setInterval(checkAndAddItems, 100);

                // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    clearInterval(checkInterval);

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏
                    showWinResult(wonSkin, caseInfo.price);

                    // –ü–ª–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä—É–ª–µ—Ç–∫—É –≤ –Ω–∞—á–∞–ª–æ
                    setTimeout(() => {
                        rouletteWheel.style.transition = 'transform 0.5s ease';
                        rouletteWheel.style.transform = 'translateX(0)';

                        setTimeout(() => {
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ä—É–ª–µ—Ç–∫—É
                            rouletteWheel.style.transition = 'none';
                            createRouletteWithTargetSkin();
                            isSpinning = false;
                            btn.disabled = false;
                            btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';

                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–µ–π—Å–∞
                            if (caseInfo.price === 0) {
                                checkFreeCaseAvailability(caseId);
                            }
                        }, 500);
                    }, 1000);

                }, 5050);

            }, 100);
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–µ–π—Å–∞', 'error');
            isSpinning = false;
            btn.disabled = false;
            btn.textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';
        });
});

function showWinResult(wonSkin, casePrice) {
    const resultDiv = document.getElementById('result');
    const rarity = getSkinRarity(wonSkin.price);
    const rarityColor = getRarityColor(rarity);

    // –ó–≤—É–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–±—ã–ª–∏
    const profit = wonSkin.price - casePrice;

    if (profit >= 0) {
        playSound('caseWinSound');
    } else {
        playSound('caseLoseSound');
    }

    resultDiv.innerHTML = `
        <div class="won-skin" style="border-color: ${rarityColor}">
            <h4>üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!</h4>
            <div class="skin-card">
                <img src="${wonSkin.image}" alt="${wonSkin.name}">
                <div class="skin-rarity ${rarity}">${getRarityName(rarity)}</div>
                <h5>${wonSkin.name}</h5>
                <p class="skin-value">${wonSkin.price.toLocaleString()} UC</p>
                <div class="profit-info">
                    <span class="profit-${profit >= 0 ? 'positive' : 'negative'}">
                        ${profit >= 0 ? '‚úÖ +' : '‚ùå '}${profit.toLocaleString()} UC
                    </span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-save" onclick="saveSkin(${wonSkin.id})">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
                <button class="btn btn-sell" onclick="sellCurrentSkin()">üí∞ –ü—Ä–æ–¥–∞—Ç—å –∑–∞ ${wonSkin.price.toLocaleString()} UC</button>
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
function saveSkin(skinId) {
    playSound('clickSound');

    fetch('/api/save_skin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({skin_id: skinId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ –°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!');
            document.querySelector('.action-buttons').innerHTML = '<p class="text-success">‚úÖ –°–∫–∏–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</p>';
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–∏–Ω–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–∫–∏–Ω–∞', 'error');
    });
}

function sellCurrentSkin() {
    if (!currentWonSkin) return;

    playSound('clickSound');

    fetch('/api/sell_skin', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({skin_id: currentWonSkin.id})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`üí∞ –°–∫–∏–Ω –ø—Ä–æ–¥–∞–Ω –∑–∞ ${data.price.toLocaleString()} UC!`);
            document.querySelector('.action-buttons').innerHTML = '<p class="text-success">üí∞ –°–∫–∏–Ω –ø—Ä–æ–¥–∞–Ω</p>';
            updateHeaderBalance();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Å–∫–∏–Ω–∞', 'error');
        }
    })
    .catch(error => {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ —Å–∫–∏–Ω–∞', 'error');
    });
}

function loadCaseSkins(caseType) {
    console.log('Loading skins for case type:', caseType);

    fetch(`/api/get_case_skins/${caseType}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Loaded skins:', data.skins ? data.skins.length : 0);

            if (data.skins && data.skins.length > 0) {
                currentSkins = data.skins;
                createRouletteWithTargetSkin(null, currentSkins);
            } else {
                console.error('No skins received from server');
                currentSkins = getDemoSkins();
                createRouletteWithTargetSkin(null, currentSkins);
            }
        })
        .catch(error => {
            console.error('Error loading case skins:', error);
            currentSkins = getDemoSkins();
            createRouletteWithTargetSkin(null, currentSkins);
        });
}

// –£–ª—É—á—à–∞–µ–º –¥–µ–º–æ-—Å–∫–∏–Ω—ã
function getDemoSkins() {
    return [
        {'id': 1, 'name': 'M416 - –°–µ—Ä—ã–π', 'image': 'https://via.placeholder.com/100/6c757d/ffffff?text=M416', 'price': 20},
        {'id': 201, 'name': 'M416 - –ì–æ–ª—É–±–æ–π –õ–µ–¥', 'image': 'https://via.placeholder.com/100/007bff/ffffff?text=M416', 'price': 150},
        {'id': 401, 'name': 'M416 - –î—Ä–∞–∫–æ–Ω–∏–π –û–≥–æ–Ω—å', 'image': 'https://via.placeholder.com/100/8a2be2/ffffff?text=M416', 'price': 800},
        {'id': 2, 'name': 'AKM - –°—Ç–∞–Ω–¥–∞—Ä—Ç', 'image': 'https://via.placeholder.com/100/6c757d/ffffff?text=AKM', 'price': 25},
        {'id': 202, 'name': 'AKM - –ö—Ä–æ–≤–∞–≤—ã–π', 'image': 'https://via.placeholder.com/100/007bff/ffffff?text=AKM', 'price': 180},
        {'id': 402, 'name': 'AKM - –í–∞–º–ø–∏—Ä', 'image': 'https://via.placeholder.com/100/8a2be2/ffffff?text=AKM', 'price': 900}
    ];
}
</script>

<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º case_detail.html */
.case-detail-container {
    padding: 20px;
}

.case-info-sidebar {
    background: rgba(45, 27, 105, 0.3);
    border: 2px solid #8a2be2;
    border-radius: 10px;
    padding: 20px;
    position: sticky;
    top: 20px;
}

.case-image {
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #8a2be2;
}

.case-price-large .uc-price {
    color: #ffd700;
    font-weight: bold;
    font-size: 28px;
    display: block;
    text-align: center;
    margin: 15px 0;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.case-price-large .free-price {
    color: #28a745;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º –∫–µ–π—Å–µ */
.free-case-info {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid #28a745;
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
}

.availability-status {
    font-weight: bold;
    margin-bottom: 5px;
}

/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
/* ... */
</style>
{% endblock %}